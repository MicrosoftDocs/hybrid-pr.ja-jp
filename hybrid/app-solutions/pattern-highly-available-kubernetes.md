---
title: Azure と Azure Stack Hub を使用した高可用性 Kubernetes パターン
description: Kubernetes クラスター ソリューションで Azure と Azure Stack Hub を使用して高可用性を実現する方法について説明します。
author: BryanLa
ms.topic: article
ms.date: 12/03/2020
ms.author: bryanla
ms.reviewer: bryanla
ms.lastreviewed: 12/03/2020
ms.openlocfilehash: 454cc0a0531882b7a8ec050a461420ce13eebcfe
ms.sourcegitcommit: df7e3e6423c3d4e8a42dae3d1acfba1d55057258
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/09/2020
ms.locfileid: "96912003"
---
# <a name="high-availability-kubernetes-cluster-pattern"></a><span data-ttu-id="87c5b-103">高可用性 Kubernetes クラスター パターン</span><span class="sxs-lookup"><span data-stu-id="87c5b-103">High availability Kubernetes cluster pattern</span></span>

<span data-ttu-id="87c5b-104">この記事では、Azure Stack Hub 上で Azure Kubernetes Service (AKS) エンジンを使用して、高可用性 Kubernetes ベースのインフラストラクチャを設計し、運用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-104">This article describes how to architect and operate a highly available Kubernetes-based infrastructure using Azure Kubernetes Service (AKS) Engine on Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-105">このシナリオは、非常に制限の厳しい規制された環境において重要なワークロードを持つ組織で一般的です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-105">This scenario is common for organizations with critical workloads in highly restricted and regulated environments.</span></span> <span data-ttu-id="87c5b-106">金融、防衛、政府機関などの領域に属する組織です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-106">Organizations in domains such as finance, defense, and government.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="87c5b-107">コンテキストと問題</span><span class="sxs-lookup"><span data-stu-id="87c5b-107">Context and problem</span></span>

<span data-ttu-id="87c5b-108">多くの組織では、Kubernetes のような最先端のサービスとテクノロジを利用するクラウドネイティブ ソリューションを開発しています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-108">Many organizations are developing cloud-native solutions that leverage state-of-the-art services and technologies like Kubernetes.</span></span> <span data-ttu-id="87c5b-109">Azure によって世界中のほとんどのリージョンにデータセンターが提供されますが、ビジネス クリティカルなアプリケーションを特定の場所で実行する必要があるエッジ ユースケースやシナリオがある場合もあります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-109">Although Azure provides datacenters in most regions of the world, sometimes there are edge use-cases and scenarios where business critical applications must run in a specific location.</span></span> <span data-ttu-id="87c5b-110">考慮事項は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-110">Considerations include:</span></span>

- <span data-ttu-id="87c5b-111">場所の機密度</span><span class="sxs-lookup"><span data-stu-id="87c5b-111">Location sensitivity</span></span>
- <span data-ttu-id="87c5b-112">アプリケーションとオンプレミス システムの間の待機時間</span><span class="sxs-lookup"><span data-stu-id="87c5b-112">Latency between the application and on-premises systems</span></span>
- <span data-ttu-id="87c5b-113">帯域幅の節約</span><span class="sxs-lookup"><span data-stu-id="87c5b-113">Bandwidth conservation</span></span>
- <span data-ttu-id="87c5b-114">接続</span><span class="sxs-lookup"><span data-stu-id="87c5b-114">Connectivity</span></span>
- <span data-ttu-id="87c5b-115">規制または法定要件</span><span class="sxs-lookup"><span data-stu-id="87c5b-115">Regulatory or statutory requirements</span></span>

<span data-ttu-id="87c5b-116">Azure を Azure Stack Hub と組み合わせると、これらの問題のほとんどに対処できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-116">Azure, in combination with Azure Stack Hub, addresses most of these concerns.</span></span> <span data-ttu-id="87c5b-117">Azure Stack Hub 上で実行されている Kubernetes を正常に実装するためのさまざまなオプション、決定事項、および考慮事項について、以下で説明します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-117">A broad set of options, decisions, and considerations for a successful implementation of Kubernetes running on Azure Stack Hub is described below.</span></span>

## <a name="solution"></a><span data-ttu-id="87c5b-118">解決策</span><span class="sxs-lookup"><span data-stu-id="87c5b-118">Solution</span></span>

<span data-ttu-id="87c5b-119">このパターンは、厳格な制約セットを処理する必要があることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-119">This pattern assumes that we have to deal with a strict set of constraints.</span></span> <span data-ttu-id="87c5b-120">アプリケーションはオンプレミスで実行する必要があり、すべての個人データがパブリック クラウド サービスに届かないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-120">The application must run on-premises and all personal data must not reach public cloud services.</span></span> <span data-ttu-id="87c5b-121">監視とその他の非 PII データを Azure に送信し、そこで処理することができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-121">Monitoring and other non-PII data can be sent to Azure and be processed there.</span></span> <span data-ttu-id="87c5b-122">パブリック Container Registry などの外部サービスにはアクセスできますが、ファイアウォールまたはプロキシ サーバーを通じてフィルター処理することができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-122">External services like a public Container Registry or others can be accessed but might be filtered through a firewall or proxy server.</span></span>

<span data-ttu-id="87c5b-123">ここに示されているサンプル アプリケーション ([Azure Kubernetes Service ワークショップ](/learn/modules/aks-workshop/)) は、可能な限り Kubernetes ネイティブ ソリューションを使用するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-123">The sample application shown here (based on [Azure Kubernetes Service Workshop](/learn/modules/aks-workshop/)) is designed to use Kubernetes-native solutions whenever possible.</span></span> <span data-ttu-id="87c5b-124">この設計では、プラットフォームネイティブ サービスを使用する代わりに、ベンダー ロックインを回避します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-124">This design avoids vendor lock-in, instead of using platform-native services.</span></span> <span data-ttu-id="87c5b-125">たとえば、アプリケーションでは、PaaS サービスや外部データベース サービスではなく、セルフホステッド MongoDB データベース バックエンドを使用します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-125">As an example, the application uses a self-hosted MongoDB database backend instead of a PaaS service or external database service.</span></span>

<span data-ttu-id="87c5b-126">[![アプリケーション パターン ハイブリッド](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="87c5b-126">[![Application Pattern Hybrid](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span></span>

<span data-ttu-id="87c5b-127">上の図は Azure Stack Hub 上の Kubernetes で実行されているサンプル アプリケーションのアプリケーション アーキテクチャを示しています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-127">The preceding diagram illustrates the application architecture of the sample application running on Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-128">アプリは、次のようないくつかのコンポーネントで構成されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-128">The app consists of several components, including:</span></span>

 1) <span data-ttu-id="87c5b-129">Azure Stack Hub 上の AKS エンジン ベースの Kubernetes クラスター。</span><span class="sxs-lookup"><span data-stu-id="87c5b-129">An AKS Engine based Kubernetes cluster on Azure Stack Hub.</span></span>
 2) <span data-ttu-id="87c5b-130">[cert-manager](https://www.jetstack.io/cert-manager/)。これは、Kubernetes 内で証明書を管理するための一連のツールを提供し、Let's Encrypt に証明書を自動的に要求するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-130">[cert-manager](https://www.jetstack.io/cert-manager/), which provides a suite of tools for certificate management in Kubernetes, used to automatically request certificates from Let's Encrypt.</span></span>
 3) <span data-ttu-id="87c5b-131">フロントエンド (ratings-web)、api (ratings-api)、データベース (ratings-mongodb) 用のアプリケーション コンポーネントを含む Kubernetes 名前空間。</span><span class="sxs-lookup"><span data-stu-id="87c5b-131">A Kubernetes namespace that contains the application components for the front end (ratings-web), api (ratings-api), and database (ratings-mongodb).</span></span>
 4) <span data-ttu-id="87c5b-132">Kubernetes クラスター内のエンドポイントに HTTP/HTTPS トラフィックをルーティングするイングレス コントローラー。</span><span class="sxs-lookup"><span data-stu-id="87c5b-132">The Ingress Controller that routes HTTP/HTTPS traffic to endpoints within the Kubernetes cluster.</span></span>

<span data-ttu-id="87c5b-133">サンプル アプリケーションは、アプリケーション アーキテクチャを示すために使用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-133">The sample application is used to illustrate the application architecture.</span></span> <span data-ttu-id="87c5b-134">すべてのコンポーネントは例です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-134">All components are examples.</span></span> <span data-ttu-id="87c5b-135">アーキテクチャには、アプリケーションのデプロイが 1 つだけ含まれています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-135">The architecture contains only a single application deployment.</span></span> <span data-ttu-id="87c5b-136">高可用性 (HA) を実現するために、2 つの異なる Azure Stack Hub インスタンス上でデプロイを少なくとも 2 回実行します。これらは、同じ場所または 2 つ (またはそれ以上) の異なるサイト内で実行できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-136">To achieve high availability (HA), we'll run the deployment at least twice on two different Azure Stack Hub instances - they can run either in the same location or in two (or more) different sites:</span></span>

![インフラストラクチャ アーキテクチャ](media/pattern-highly-available-kubernetes/aks-azure-architecture.png)

<span data-ttu-id="87c5b-138">Azure Container Registry、Azure Monitor などのサービスは、Azure 内またはオンプレミスの Azure Stack Hub の外部でホストされます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-138">Services like Azure Container Registry, Azure Monitor, and others, are hosted outside Azure Stack Hub in Azure or on-premises.</span></span> <span data-ttu-id="87c5b-139">このハイブリッド設計では、単一の Azure Stack Hub インスタンスの停止からソリューションを保護します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-139">This hybrid design protects the solution against outage of a single Azure Stack Hub instance.</span></span>

## <a name="components"></a><span data-ttu-id="87c5b-140">コンポーネント</span><span class="sxs-lookup"><span data-stu-id="87c5b-140">Components</span></span>

<span data-ttu-id="87c5b-141">全体的なアーキテクチャは、次のコンポーネントで構成されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-141">The overall architecture consists of the following components:</span></span>

<span data-ttu-id="87c5b-142">**Azure Stack Hub** は Azure の拡張機能であり、データセンター内で Azure サービスを提供することによりオンプレミス環境でワークロードを実行できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-142">**Azure Stack Hub** is an extension of Azure that can run workloads in an on-premises environment by providing Azure services in your datacenter.</span></span> <span data-ttu-id="87c5b-143">詳細については、「[Azure Stack Hub の概要](/azure-stack/operator/azure-stack-overview)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-143">Go to [Azure Stack Hub overview](/azure-stack/operator/azure-stack-overview) to learn more.</span></span>

<span data-ttu-id="87c5b-144">**Azure Kubernetes Service エンジン (AKS エンジン)** は、現在 Azure で利用可能なマネージド Kubernetes サービス オファリング (Azure Kubernetes Service (AKS)) の背後にあるエンジンです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-144">**Azure Kubernetes Service Engine (AKS Engine)** is the engine behind the managed Kubernetes service offering, Azure Kubernetes Service (AKS), that is available in Azure today.</span></span> <span data-ttu-id="87c5b-145">Azure Stack Hub の場合、AKS エンジンにより、Azure Stack Hub の IaaS 機能を使用して、完全に機能するセルフマネージド Kubernetes クラスターをデプロイ、スケール、アップグレードすることができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-145">For Azure Stack Hub, AKS Engine allows us to deploy, scale, and upgrade fully featured, self-managed Kubernetes clusters using Azure Stack Hub's IaaS capabilities.</span></span> <span data-ttu-id="87c5b-146">詳細については、[AKS エンジンの概要](https://github.com/Azure/aks-engine)に関するページをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-146">Go to [AKS Engine Overview](https://github.com/Azure/aks-engine) to learn more.</span></span>

<span data-ttu-id="87c5b-147">Azure 上の AKS エンジンと Azure Stack Hub 上の AKS エンジンの違いについては、「[既知の問題と制限](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-147">Go to [Known Issues and Limitations](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations) to learn more about the differences between AKS Engine on Azure and AKS Engine on Azure Stack Hub.</span></span>

<span data-ttu-id="87c5b-148">**Azure Virtual Network (VNet)** は、Kubernetes クラスター インフラストラクチャをホストする仮想マシン (VM) の各 Azure Stack Hub 上でネットワーク インフラストラクチャを提供するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-148">**Azure Virtual Network (VNet)** is used to provide the network infrastructure on each Azure Stack Hub for the Virtual Machines (VMs) hosting the Kubernetes cluster infrastructure.</span></span>

<span data-ttu-id="87c5b-149">**Azure Load Balancer** は、Kubernetes API エンドポイントと Nginx イングレス コントローラーに使用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-149">**Azure Load Balancer** is used for the Kubernetes API Endpoint and the Nginx Ingress Controller.</span></span> <span data-ttu-id="87c5b-150">ロード バランサーは、特定のサービスを提供しているノードと VM に外部 (インターネットなど) トラフィックをルーティングします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-150">The load balancer routes external (for example, Internet) traffic to nodes and VMs offering a specific service.</span></span>

<span data-ttu-id="87c5b-151">**Azure Container Registry (ACR)** は、クラスターにデプロイされたプライベート Docker イメージと Helm チャートを格納するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-151">**Azure Container Registry (ACR)** is used to store private Docker images and Helm charts, which are deployed to the cluster.</span></span> <span data-ttu-id="87c5b-152">AKS エンジンは、Azure AD ID を使用してコンテナー レジストリに対して認証できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-152">AKS Engine can authenticate with the Container Registry using an Azure AD identity.</span></span> <span data-ttu-id="87c5b-153">Kubernetes には ACR は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-153">Kubernetes doesn't require ACR.</span></span> <span data-ttu-id="87c5b-154">Docker Hub などの他のコンテナー レジストリを使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-154">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="87c5b-155">**Azure Repos** は、コードの管理に使用できるバージョン管理ツールのセットです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-155">**Azure Repos** is a set of version control tools that you can use to manage your code.</span></span> <span data-ttu-id="87c5b-156">GitHub またはその他の git ベースのリポジトリを使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-156">You can also use GitHub or other git-based repositories.</span></span> <span data-ttu-id="87c5b-157">詳細については、[Azure Repos の概要](/azure/devops/repos/get-started/what-is-repos)に関する記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-157">Go to [Azure Repos Overview](/azure/devops/repos/get-started/what-is-repos) to learn more.</span></span>

<span data-ttu-id="87c5b-158">**Azure Pipelines** は Azure DevOps Services の一部であり、自動化されたビルド、テスト、およびデプロイを実行します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-158">**Azure Pipelines** is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="87c5b-159">Jenkins などのサードパーティ CI/CD ソリューションも使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-159">You can also use third-party CI/CD solutions such as Jenkins.</span></span> <span data-ttu-id="87c5b-160">詳細については、[Azure Pipeline の概要](/azure/devops/pipelines/get-started/what-is-azure-pipelines)に関する記事をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-160">Go to [Azure Pipeline Overview](/azure/devops/pipelines/get-started/what-is-azure-pipelines) to learn more.</span></span>

<span data-ttu-id="87c5b-161">**Azure Monitor** では、ソリューション内の Azure サービスのプラットフォーム メトリックやアプリケーション テレメトリなど、メトリックとログが収集されて格納されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-161">**Azure Monitor** collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="87c5b-162">このデータは、アプリケーションを監視したり、アラートやダッシュボードを設定したり、障害の根本原因分析を実行したりするために使用します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-162">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="87c5b-163">Azure Monitor は、コントローラー、ノード、およびコンテナーからのメトリックや、コンテナー ログおよびマスター ノード ログを収集するために Kubernetes と統合します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-163">Azure Monitor integrates with Kubernetes to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span> <span data-ttu-id="87c5b-164">詳細については、「[Azure Monitor の概要](/azure/azure-monitor/overview)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-164">Go to [Azure Monitor Overview](/azure/azure-monitor/overview) to learn more.</span></span>

<span data-ttu-id="87c5b-165">**Azure Traffic Manager** は、異なる Azure リージョンまたは Azure Stack Hub デプロイにまたがってトラフィックをサービスに最適に配分できるようにする DNS ベースのトラフィック ロード バランサーです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-165">**Azure Traffic Manager** is a DNS-based traffic load balancer that enables you to distribute traffic optimally to services across different Azure regions or Azure Stack Hub deployments.</span></span> <span data-ttu-id="87c5b-166">Traffic Manager により、高可用性と応答性も提供されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-166">Traffic Manager also provides high availability and responsiveness.</span></span> <span data-ttu-id="87c5b-167">アプリケーション エンドポイントは、外部からアクセスできる必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-167">The application endpoints must be accessible from the outside.</span></span> <span data-ttu-id="87c5b-168">他のオンプレミス ソリューションも利用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-168">There are other on-premises solutions available as well.</span></span>

<span data-ttu-id="87c5b-169">**Kubernetes イングレス コントローラー** により、Kubernetes クラスター内のサービスへの HTTP(S) ルートが公開されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-169">**Kubernetes Ingress Controller** exposes HTTP(S) routes to services in a Kubernetes cluster.</span></span> <span data-ttu-id="87c5b-170">この目的には、Nginx または任意の適切なイングレス コントローラーを使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-170">Nginx or any suitable ingress controller can be used for this purpose.</span></span>

<span data-ttu-id="87c5b-171">**Helm** は、Kubernetes デプロイ用のパッケージ マネージャーであり、デプロイ、サービス、シークレットなどのさまざまな Kubernetes オブジェクトを 1 つの "チャート" にバンドルする手段を提供します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-171">**Helm** is a package manager for Kubernetes deployment, providing a way to bundle different Kubernetes objects like Deployments, Services, Secrets, into a single "chart".</span></span> <span data-ttu-id="87c5b-172">チャート オブジェクトの発行、デプロイ、制御バージョン管理、および更新を行うことができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-172">You can publish, deploy, control version management, and update a chart  object.</span></span> <span data-ttu-id="87c5b-173">Azure Container Registry は、パッケージ化された Helm チャートを格納するためのリポジトリとして使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-173">Azure Container Registry can be used as a repository to store packaged Helm Charts.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="87c5b-174">設計上の考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-174">Design considerations</span></span>

<span data-ttu-id="87c5b-175">このパターンは、この記事の次以降のセクションで詳しく説明されているいくつかの高レベルの考慮事項に従います。</span><span class="sxs-lookup"><span data-stu-id="87c5b-175">This pattern follows a few high-level considerations explained in more detail in the next sections of this article:</span></span>

- <span data-ttu-id="87c5b-176">アプリケーションでは、ベンダー ロックインを避けるために、Kubernetes ネイティブ ソリューションを使用します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-176">The application uses Kubernetes-native solutions, to avoid vendor lock-in.</span></span>
- <span data-ttu-id="87c5b-177">アプリケーションではマイクロサービス アーキテクチャが使用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-177">The application uses a microservices architecture.</span></span>
- <span data-ttu-id="87c5b-178">Azure Stack Hub では受信は必要ありませんが、送信インターネット接続が許可されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-178">Azure Stack Hub doesn't need inbound but allows outbound Internet connectivity.</span></span>

<span data-ttu-id="87c5b-179">これらの推奨プラクティスは、実際のワークロードとシナリオにも適用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-179">These recommended practices will apply to real-world workloads and scenarios as well.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="87c5b-180">スケーラビリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-180">Scalability considerations</span></span>

<span data-ttu-id="87c5b-181">スケーラビリティは、一貫性があり信頼性とパフォーマンスの高いアプリケーションへのアクセスをユーザーに提供するために重要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-181">Scalability is important to provide users consistent, reliable, and well-performing access to the application.</span></span>

<span data-ttu-id="87c5b-182">サンプル シナリオでは、複数レイヤーのアプリケーション スタックのスケーラビリティについて説明します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-182">The sample scenario covers scalability on multiple layers of the application stack.</span></span> <span data-ttu-id="87c5b-183">さまざまなレイヤーの概要を次に示します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-183">Here's a high-level overview of the different layers:</span></span>

| <span data-ttu-id="87c5b-184">アーキテクチャ レベル</span><span class="sxs-lookup"><span data-stu-id="87c5b-184">Architecture level</span></span> | <span data-ttu-id="87c5b-185">影響</span><span class="sxs-lookup"><span data-stu-id="87c5b-185">Affects</span></span> | <span data-ttu-id="87c5b-186">方法はありますか。</span><span class="sxs-lookup"><span data-stu-id="87c5b-186">How?</span></span> |
| --- | --- | ---
| <span data-ttu-id="87c5b-187">Application</span><span class="sxs-lookup"><span data-stu-id="87c5b-187">Application</span></span> | <span data-ttu-id="87c5b-188">Application</span><span class="sxs-lookup"><span data-stu-id="87c5b-188">Application</span></span> | <span data-ttu-id="87c5b-189">ポッド、レプリカ、コンテナー インスタンスの数に基づく水平スケーリング\*</span><span class="sxs-lookup"><span data-stu-id="87c5b-189">Horizontal scaling based on the number of Pods/Replicas/Container Instances\*</span></span> |
| <span data-ttu-id="87c5b-190">クラスター</span><span class="sxs-lookup"><span data-stu-id="87c5b-190">Cluster</span></span> | <span data-ttu-id="87c5b-191">Kubernetes クラスター</span><span class="sxs-lookup"><span data-stu-id="87c5b-191">Kubernetes cluster</span></span> | <span data-ttu-id="87c5b-192">ノード数 (1 から 50)、VM-SKU サイズ、およびノード プール (Azure Stack Hub 上の AKS エンジンは、現在 1 つのノード プールのみをサポート)。AKS エンジンの scale コマンドを使用 (手動)</span><span class="sxs-lookup"><span data-stu-id="87c5b-192">Number of Nodes (between 1 and 50), VM-SKU-sizes, and Node Pools (AKS Engine on Azure Stack Hub currently supports only a single node pool); using AKS Engine's scale command (manual)</span></span> |
| <span data-ttu-id="87c5b-193">インフラストラクチャ</span><span class="sxs-lookup"><span data-stu-id="87c5b-193">Infrastructure</span></span> | <span data-ttu-id="87c5b-194">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="87c5b-194">Azure Stack Hub</span></span> | <span data-ttu-id="87c5b-195">Azure Stack Hub デプロイ内のノード数、容量、およびスケール ユニット数</span><span class="sxs-lookup"><span data-stu-id="87c5b-195">Number of nodes, capacity, and scale units within an Azure Stack Hub deployment</span></span> |

<span data-ttu-id="87c5b-196">\* Kubernetes の ポッドの水平オートスケーラー (HPA) を使用。コンテナー インスタンス (CPU やメモリ) のサイズ変更による、自動化されたメトリックベースのスケーリングまたは垂直スケーリング。</span><span class="sxs-lookup"><span data-stu-id="87c5b-196">\* Using Kubernetes' Horizontal Pod Autoscaler (HPA); automated metric-based scaling or vertical scaling by sizing the container instances (cpu/memory).</span></span>

<span data-ttu-id="87c5b-197">**Azure Stack Hub (インフラストラクチャ レベル)**</span><span class="sxs-lookup"><span data-stu-id="87c5b-197">**Azure Stack Hub (infrastructure level)**</span></span>

<span data-ttu-id="87c5b-198">Azure Stack Hub はデータセンター内の物理ハードウェア上で実行されるため、Azure Stack Hub インフラストラクチャはこの実装の基盤です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-198">The Azure Stack Hub infrastructure is the foundation of this implementation, because Azure Stack Hub runs on physical hardware in a datacenter.</span></span> <span data-ttu-id="87c5b-199">ハブ ハードウェアを選択するときは、CPU、メモリ密度、ストレージ構成、およびサーバー数を選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-199">When selecting your Hub hardware, you need to make choices for CPU, memory density, storage configuration, and number of servers.</span></span> <span data-ttu-id="87c5b-200">Azure Stack Hub のスケーラビリティの詳細については、次のリソースをご確認ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-200">To learn more about Azure Stack Hub's scalability, check out the following resources:</span></span>

- [<span data-ttu-id="87c5b-201">Azure Stack Hub のためのキャパシティ プランニングの概要</span><span class="sxs-lookup"><span data-stu-id="87c5b-201">Capacity planning for Azure Stack Hub overview</span></span>](/azure-stack/operator/azure-stack-capacity-planning-overview)
- [<span data-ttu-id="87c5b-202">Azure Stack Hub のスケール ユニット ノードを追加する</span><span class="sxs-lookup"><span data-stu-id="87c5b-202">Add additional scale unit nodes in Azure Stack Hub</span></span>](/azure-stack/operator/azure-stack-add-scale-node)

<span data-ttu-id="87c5b-203">**Kubernetes クラスター (クラスター レベル)**</span><span class="sxs-lookup"><span data-stu-id="87c5b-203">**Kubernetes cluster (cluster level)**</span></span>

<span data-ttu-id="87c5b-204">Kubernetes クラスター自体は、コンピューティング、ストレージ、ネットワーク リソースなどの Azure (Stack) IaaS コンポーネントで構成され、それらの上に構築されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-204">The Kubernetes cluster itself consists of, and is built on top of Azure (Stack) IaaS components including compute, storage, and network resources.</span></span> <span data-ttu-id="87c5b-205">Kubernetes ソリューションには、Azure (および Azure Stack Hub) 内に VM としてデプロイされるマスターおよびワーカー ノードが含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-205">Kubernetes solutions involve master and worker nodes, which are deployed as VMs in Azure (and Azure Stack Hub).</span></span>

- <span data-ttu-id="87c5b-206">[コントロール プレーン](/azure/aks/concepts-clusters-workloads#control-plane) (マスター) により、主要な Kubernetes サービスと、アプリケーション ワークロードのオーケストレーションが提供されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-206">[Control plane nodes](/azure/aks/concepts-clusters-workloads#control-plane) (master) provide the core Kubernetes services and orchestration of application workloads.</span></span>
- <span data-ttu-id="87c5b-207">[ワーカー ノード](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (ワーカー) により、アプリケーション ワークロードが実行されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-207">[Worker nodes](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (worker) run your application workloads.</span></span>

<span data-ttu-id="87c5b-208">初期デプロイの VM サイズを選択する際には、いくつかの考慮事項があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-208">When selecting VM sizes for the initial deployment, there are several considerations:</span></span>  

- <span data-ttu-id="87c5b-209">**コスト** - ワーカー ノードを計画するときは、発生する VM ごとのコスト全体を念頭に置いてください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-209">**Cost** - When planning your worker nodes, keep in mind the overall cost per VM you'll incur.</span></span> <span data-ttu-id="87c5b-210">たとえば、アプリケーションのワークロードに限られたリソースが必要な場合は、サイズの小さい VM をデプロイすることを計画する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-210">For example, if your application workloads require limited resources, you should plan to deploy smaller sized VMs.</span></span> <span data-ttu-id="87c5b-211">Azure のような Azure Stack Hub は通常、消費量に基づいて課金されるため、Kubernetes ロール用に VM を適切にサイズ設定することは、消費コストを最適化するために重要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-211">Azure Stack Hub, like Azure, is normally billed on a consumption basis, so appropriately sizing the VMs for Kubernetes roles is crucial to optimizing consumption costs.</span></span> 

- <span data-ttu-id="87c5b-212">**スケーラビリティ** - マスターおよびワーカー ノードの数をスケールインおよびアウトしたり、追加のノード プールを追加したりすることによって (現在、Azure Stack Hub 上では利用できません)、クラスターのスケーラビリティが実現されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-212">**Scalability** - Scalability of the cluster is achieved by scaling in and out the number of master and worker nodes, or by adding additional node pools (not available on Azure Stack Hub today).</span></span> <span data-ttu-id="87c5b-213">クラスターのスケーリングは、Container Insights (Azure Monitor + Log Analytics) を使用して収集されたパフォーマンス データに基づいて行うことができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-213">Scaling the cluster can be done based on performance data, collected using Container Insights (Azure Monitor + Log Analytics).</span></span> 

    <span data-ttu-id="87c5b-214">アプリケーションに必要なリソースが増減する場合は、現在のノードを水平方向 (1 から 50 ノード) にスケールアウト (またはイン) できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-214">If your application needs more (or fewer) resources, you can scale out (or in) your current nodes horizontally (between 1 and 50 nodes).</span></span> <span data-ttu-id="87c5b-215">50 を超えるノードが必要な場合は、別のサブスクリプション内で追加のクラスターを作成できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-215">If you need more than 50 nodes, you can create an additional cluster in a separate subscription.</span></span> <span data-ttu-id="87c5b-216">クラスターを再デプロイしないと、実際の VM を別の VM サイズに垂直方向にスケールアップすることはできません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-216">You can't scale up the actual VMs vertically to another VM size without redeploying the cluster.</span></span>

    <span data-ttu-id="87c5b-217">スケーリングは、最初に Kubernetes クラスターをデプロイするために使用された AKS エンジン ヘルパー VM を使用して手動で行います。</span><span class="sxs-lookup"><span data-stu-id="87c5b-217">Scaling is done manually using the AKS Engine helper VM that was used to deploy the Kubernetes cluster initially.</span></span> <span data-ttu-id="87c5b-218">詳細については、「[Kubernetes クラスターのスケーリング](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)」を参照してください</span><span class="sxs-lookup"><span data-stu-id="87c5b-218">For more information, see [Scaling Kubernetes clusters](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span></span>

- <span data-ttu-id="87c5b-219">**クォータ** - Azure Stack Hub 上で AKS のデプロイを計画するときに構成した[クォータ](/azure-stack/operator/azure-stack-quota-types)について検討します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-219">**Quotas** - Consider the [quotas](/azure-stack/operator/azure-stack-quota-types) you've configured when planning out an AKS deployment on your Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-220">各[サブスクリプション](/azure-stack/operator/service-plan-offer-subscription-overview)に適切なプランとクォータが構成されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-220">Make sure each [subscription](/azure-stack/operator/service-plan-offer-subscription-overview) has the proper plans and the quotas configured.</span></span> <span data-ttu-id="87c5b-221">サブスクリプションは、スケールアウトの際にクラスターに必要なコンピューティング、ストレージ、およびその他のサービスの量に対応できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-221">The subscription will need to accommodate the amount of compute, storage, and other services needed for your clusters as they scale out.</span></span>

- <span data-ttu-id="87c5b-222">**アプリケーションのワークロード** - Azure Kubernetes Service ドキュメントの Kubernetes コア概念に関する記事で[クラスターとワークロードの概念](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools)に関するページをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-222">**Application workloads** - Refer to the [Clusters and workloads concepts](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) in the Kubernetes core concepts for Azure Kubernetes Service document.</span></span> <span data-ttu-id="87c5b-223">この記事は、アプリケーションのコンピューティングとメモリのニーズに基づいて適切な VM サイズを調べるのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-223">This article will help you scope the proper VM size based on the compute and memory needs of your application.</span></span>  

<span data-ttu-id="87c5b-224">**アプリケーション (アプリケーション レベル)**</span><span class="sxs-lookup"><span data-stu-id="87c5b-224">**Application (application level)**</span></span>

<span data-ttu-id="87c5b-225">アプリケーション レイヤーでは、Kubernetes の[ポッドの水平オートスケーラー (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/) を使用します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-225">On the application layer, we use Kubernetes [Horizontal Pod Autoscaler (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/).</span></span> <span data-ttu-id="87c5b-226">HPA を使用して、さまざまなメトリック (CPU 使用率など) に基づいて、デプロイ内のレプリカ (ポッドとコンテナー インスタンス) の数を増減できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-226">HPA can increase or decrease the number of Replicas (Pod/Container Instances) in our deployment based on different metrics (like CPU utilization).</span></span>

<span data-ttu-id="87c5b-227">別の方法として、コンテナー インスタンスを垂直方向にスケーリングすることもできます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-227">Another option is to scale container instances vertically.</span></span> <span data-ttu-id="87c5b-228">これは、特定のデプロイで要求され、使用できる CPU とメモリの量を変更することによって実現できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-228">This can be accomplished by changing the amount of CPU and Memory requested and available for a specific deployment.</span></span> <span data-ttu-id="87c5b-229">詳細については、kubernetes.io で「[コンテナーのリソース管理](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-229">See [Managing Resources for Containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) on kubernetes.io to learn more.</span></span>

## <a name="networking-and-connectivity-considerations"></a><span data-ttu-id="87c5b-230">ネットワークと接続性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-230">Networking and connectivity considerations</span></span>

<span data-ttu-id="87c5b-231">ネットワークと接続は、Azure Stack Hub 上の Kubernetes について前述した 3 つのレイヤーにも影響します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-231">Networking and connectivity also affect the three layers mentioned previously for Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-232">次の表は、レイヤーとそれらに含まれるサービスを示しています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-232">The following table shows the layers and which services they contain:</span></span>

| <span data-ttu-id="87c5b-233">レイヤー</span><span class="sxs-lookup"><span data-stu-id="87c5b-233">Layer</span></span> | <span data-ttu-id="87c5b-234">影響</span><span class="sxs-lookup"><span data-stu-id="87c5b-234">Affects</span></span> | <span data-ttu-id="87c5b-235">何ですか?</span><span class="sxs-lookup"><span data-stu-id="87c5b-235">What?</span></span> |
| --- | --- | ---
| <span data-ttu-id="87c5b-236">Application</span><span class="sxs-lookup"><span data-stu-id="87c5b-236">Application</span></span> | <span data-ttu-id="87c5b-237">Application</span><span class="sxs-lookup"><span data-stu-id="87c5b-237">Application</span></span> | <span data-ttu-id="87c5b-238">アプリケーションにアクセスする方法。</span><span class="sxs-lookup"><span data-stu-id="87c5b-238">How is the application accessible?</span></span> <span data-ttu-id="87c5b-239">インターネットに公開されるかどうか。</span><span class="sxs-lookup"><span data-stu-id="87c5b-239">Will it be exposed to the Internet?</span></span> |
| <span data-ttu-id="87c5b-240">クラスター</span><span class="sxs-lookup"><span data-stu-id="87c5b-240">Cluster</span></span> | <span data-ttu-id="87c5b-241">Kubernetes クラスター</span><span class="sxs-lookup"><span data-stu-id="87c5b-241">Kubernetes cluster</span></span> | <span data-ttu-id="87c5b-242">Kubernetes API、AKS エンジン VM、コンテナー イメージのプル (エグレス)、監視データとテレメトリの送信 (エグレス)</span><span class="sxs-lookup"><span data-stu-id="87c5b-242">Kubernetes API, AKS Engine VM, Pulling container images (egress), Sending monitoring data and telemetry (egress)</span></span> |
| <span data-ttu-id="87c5b-243">インフラストラクチャ</span><span class="sxs-lookup"><span data-stu-id="87c5b-243">Infrastructure</span></span> | <span data-ttu-id="87c5b-244">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="87c5b-244">Azure Stack Hub</span></span> | <span data-ttu-id="87c5b-245">ポータルや Azure Resource Manager エンドポイントなどの Azure Stack Hub 管理エンドポイントのアクセシビリティ。</span><span class="sxs-lookup"><span data-stu-id="87c5b-245">Accessibility of the Azure Stack Hub management endpoints like the portal and Azure Resource Manager endpoints.</span></span> |

<span data-ttu-id="87c5b-246">**アプリケーション**。</span><span class="sxs-lookup"><span data-stu-id="87c5b-246">**Application**</span></span>

<span data-ttu-id="87c5b-247">アプリケーション レイヤーの場合、最も重要な考慮事項は、アプリケーションが公開され、インターネットからアクセス可能であるかどうかです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-247">For the application layer, the most important consideration is whether the application is exposed and accessible from the Internet.</span></span> <span data-ttu-id="87c5b-248">Kubernetes の観点から見ると、インターネット アクセシビリティとは、Kubernetes サービスまたはイングレス コントローラーを使用してデプロイまたはポッドを公開することを意味します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-248">From a Kubernetes perspective, Internet accessibility means exposing a deployment or pod using a Kubernetes Service or an Ingress Controller.</span></span>

> [!NOTE]
> <span data-ttu-id="87c5b-249">Azure Stack Hub 上のフロントエンド パブリック IP の数は 5 つに制限されているため、イングレス コントローラーを使用して Kubernetes サービスを公開することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-249">We recommend the use of Ingress controllers to expose Kubernetes Services as the number of Frontend public IPs on Azure Stack Hub is limited to 5.</span></span> <span data-ttu-id="87c5b-250">この設計では、(LoadBalancer タイプの) Kubernetes サービスの数も 5 つに制限されます。これは、多くのデプロイに対して小さすぎます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-250">This design also limits the number of Kubernetes Services (with the type LoadBalancer) to 5, which will be too small for many deployments.</span></span> <span data-ttu-id="87c5b-251">詳細については、[AKS エンジンのドキュメント](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips)をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-251">Go to the [AKS Engine documentation](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips) to learn more.</span></span>

<span data-ttu-id="87c5b-252">ロード バランサーまたはイングレス コントローラーを介してパブリック IP を使用してアプリケーションを公開することは、アプリケーションがインターネット経由でアクセスできるようになったことを意味するものではありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-252">Exposing an application using a public IP via a Load Balancer or an Ingress Controller doesn't nessecarily mean that the application is now accessible via the Internet.</span></span> <span data-ttu-id="87c5b-253">Azure Stack Hub は、ローカル イントラネット上でのみ見えるパブリック IP アドレスを持つことができます。すべてのパブリック IP アドレスが実際にインターネットに接続されているわけではありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-253">It's possible for Azure Stack Hub to have a public IP address that is only visible on the local intranet - not all public IPs are truly Internet-facing.</span></span>

<span data-ttu-id="87c5b-254">前のブロックでは、アプリケーションへのイングレス トラフィックを考慮しています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-254">The previous block considers ingress traffic to the application.</span></span> <span data-ttu-id="87c5b-255">Kubernetes のデプロイを成功させるために考慮する必要があるもう 1 つのトピックは、送信およびエグレス トラフィックです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-255">Another topic that must be considered for a successful Kubernetes deployment is outbound/egress traffic.</span></span> <span data-ttu-id="87c5b-256">エグレス トラフィックを必要とするいくつかのユース ケースを次に示します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-256">Here are a few use cases that require egress traffic:</span></span>

- <span data-ttu-id="87c5b-257">DockerHub または Azure Container Registry に格納されているコンテナー イメージのプル</span><span class="sxs-lookup"><span data-stu-id="87c5b-257">Pulling Container Images stored on DockerHub or Azure Container Registry</span></span>
- <span data-ttu-id="87c5b-258">Helm チャートの取得</span><span class="sxs-lookup"><span data-stu-id="87c5b-258">Retrieving Helm Charts</span></span>
- <span data-ttu-id="87c5b-259">Application Insights データ (またはその他の監視データ) の出力</span><span class="sxs-lookup"><span data-stu-id="87c5b-259">Emitting Application Insights data (or other monitoring data)</span></span>

<span data-ttu-id="87c5b-260">一部のエンタープライズ環境では "_透過的_" または "_非透過的_" プロキシ サーバーの使用が必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-260">Some enterprise environments might require the use of _transparent_ or _non-transparent_ proxy servers.</span></span> <span data-ttu-id="87c5b-261">これらのサーバーには、クラスターのさまざまなコンポーネントに対する特定の構成が必要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-261">These servers require specific configuration on various components of our cluster.</span></span> <span data-ttu-id="87c5b-262">AKS エンジンのドキュメントには、ネットワーク プロキシに対応する方法についてのさまざまな詳細が記載されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-262">The AKS Engine documentation contains various details on how to accommodate network proxies.</span></span> <span data-ttu-id="87c5b-263">詳細については、「[AKS エンジンとプロキシ サーバー](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)」を参照してください</span><span class="sxs-lookup"><span data-stu-id="87c5b-263">For more details, see [AKS Engine and proxy servers](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span></span>

<span data-ttu-id="87c5b-264">最後に、クラスター間のトラフィックは、Azure Stack Hub インスタンス間を流れる必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-264">Lastly, cross-cluster traffic must flow between Azure Stack Hub instances.</span></span> <span data-ttu-id="87c5b-265">サンプルのデプロイは、個々の Azure Stack Hub インスタンス上で実行されている個々の Kubernetes クラスターで構成されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-265">The sample deployment consists of individual Kubernetes clusters running on individual Azure Stack Hub instances.</span></span> <span data-ttu-id="87c5b-266">2 つのデータベース間のレプリケーション トラフィックなど、これらの間のトラフィックは "外部トラフィック" です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-266">Traffic between them, such as the replication traffic between two databases, is "external traffic".</span></span> <span data-ttu-id="87c5b-267">外部トラフィックは、2 つの Azure Stack Hub インスタンス上で Kubernetes を接続するために、サイト間 VPN または Azure Stack Hub のパブリック IP アドレスを通じてルーティングする必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-267">External traffic must be routed through either a Site-to-Site VPN or Azure Stack Hub Public IP addresses to connect Kubernetes on two Azure Stack Hub instances:</span></span>

![クラスター間または内トラフィック](media/pattern-highly-available-kubernetes/aks-inter-and-intra-cluster-traffic.png)

<span data-ttu-id="87c5b-269">**クラスター**</span><span class="sxs-lookup"><span data-stu-id="87c5b-269">**Cluster**</span></span>  

<span data-ttu-id="87c5b-270">Kubernetes クラスターには、必ずしもインターネット経由でアクセスできる必要はありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-270">The Kubernetes cluster doesn't necessarily need to be accessible via the Internet.</span></span> <span data-ttu-id="87c5b-271">関連する部分は、たとえば `kubectl` を使用したクラスターの操作に使用される Kubernetes API です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-271">The relevant part is the Kubernetes API used to operate a cluster, for example, using `kubectl`.</span></span> <span data-ttu-id="87c5b-272">Kubernetes API エンドポイントは、クラスターを操作するすべてのユーザーからアクセスできるようにするか、アプリケーションとサービスをその上にデプロイする必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-272">The Kubernetes API endpoint must be accessible to everyone who operates the cluster or deploys applications and services on top of it.</span></span> <span data-ttu-id="87c5b-273">このトピックの詳細については、下の「[デプロイ (CI/CD) に関する考慮事項](#deployment-cicd-considerations)」で DevOps の観点から見た詳細をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-273">This topic is covered in more detail from a DevOps-perspective in the [Deployment (CI/CD) considerations](#deployment-cicd-considerations) section below.</span></span>

<span data-ttu-id="87c5b-274">クラスター レベルでは、エグレス トラフィックに関する考慮事項もいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-274">On the cluster level, there are also a few considerations around egress-traffic:</span></span>

- <span data-ttu-id="87c5b-275">ノードの更新 (Ubuntu の場合)</span><span class="sxs-lookup"><span data-stu-id="87c5b-275">Node updates (for Ubuntu)</span></span>
- <span data-ttu-id="87c5b-276">(Azure LogAnalytics に送信された) データの監視</span><span class="sxs-lookup"><span data-stu-id="87c5b-276">Monitoring data (sent to Azure LogAnalytics)</span></span>
- <span data-ttu-id="87c5b-277">送信トラフィックを必要とする他のエージェント (各デプロイ担当者の環境に固有)</span><span class="sxs-lookup"><span data-stu-id="87c5b-277">Other agents requiring outbound traffic (specific to each deployer's environment)</span></span>

<span data-ttu-id="87c5b-278">AKS エンジンを使用して Kubernetes クラスターをデプロイする前に、最終的なネットワーク設計を計画してください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-278">Before you deploy your Kubernetes cluster using AKS Engine, plan for the final networking design.</span></span> <span data-ttu-id="87c5b-279">専用の仮想ネットワークを作成するのではなく、既存のネットワークにクラスターをデプロイする方が効率的な場合があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-279">Instead of creating a dedicated Virtual Network, it may be more efficient to deploy a cluster into an existing network.</span></span> <span data-ttu-id="87c5b-280">たとえば、Azure Stack Hub 環境で既に構成されている既存のサイト間 VPN 接続を利用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-280">For example, you might leverage an existing Site-to-Site VPN connection already configured in your Azure Stack Hub environment.</span></span>

<span data-ttu-id="87c5b-281">**インフラストラクチャ**</span><span class="sxs-lookup"><span data-stu-id="87c5b-281">**Infrastructure**</span></span>  

<span data-ttu-id="87c5b-282">インフラストラクチャとは、Azure Stack Hub 管理エンドポイントへのアクセスを指します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-282">Infrastructure refers to accessing the Azure Stack Hub management endpoints.</span></span> <span data-ttu-id="87c5b-283">エンドポイントには、テナントと管理ポータル、および Azure Resource Manager 管理者とテナントのエンドポイントが含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-283">Endpoints include the tenant and admin portals, and the Azure Resource Manager admin and tenant endpoints.</span></span> <span data-ttu-id="87c5b-284">これらのエンドポイントは、Azure Stack Hub とそのコア サービスを操作するために必要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-284">These endpoints are required to operate Azure Stack Hub and its core services.</span></span>

## <a name="data-and-storage-considerations"></a><span data-ttu-id="87c5b-285">データとストレージに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-285">Data and storage considerations</span></span>

<span data-ttu-id="87c5b-286">2 つの Azure Stack Hub インスタンスにまたがって、2 つの個別の Kubernetes クラスターにアプリケーションの 2 つのインスタンスがデプロイされます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-286">Two instances of our application will be deployed, on two individual Kubernetes clusters, across two Azure Stack Hub instances.</span></span> <span data-ttu-id="87c5b-287">この設計の場合、データをレプリケートしてそれらの間で同期する方法を検討する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-287">This design will require us to consider how to replicate and synchronize data between them.</span></span>

<span data-ttu-id="87c5b-288">Azure では、クラウド内の複数のリージョンとゾーンにわたってストレージをレプリケートする機能が組み込まれています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-288">With Azure, we have the built-in capability to replicate storage across multiple regions and zones within the cloud.</span></span> <span data-ttu-id="87c5b-289">現在 Azure Stack Hub には、2つの異なる Azure Stack Hub インスタンスにストレージをレプリケートするネイティブな方法はありません。2 つの独立したクラウドが形成され、それらをセットとして管理するための包括的な方法はありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-289">Currently with Azure Stack Hub there are no native ways to replicate storage across two different Azure Stack Hub instances - they form two independent clouds with no overarching way to manage them as a set.</span></span> <span data-ttu-id="87c5b-290">Azure Stack Hub で実行されているアプリケーションの回復性を計画すると、アプリケーションの設計とデプロイにおいて、このような独立性を考慮せざるを得なくなります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-290">Planning for resiliency of applications running across Azure Stack Hub forces you to consider this independence in your application design and deployments.</span></span>

<span data-ttu-id="87c5b-291">ほとんどの場合、AKS にデプロイされた回復力のある高可用性アプリケーションにはストレージのレプリケーションは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-291">In most cases, storage replication won't be necessary for a resilient and highly available application deployed on AKS.</span></span> <span data-ttu-id="87c5b-292">ただし、アプリケーションの設計では、Azure Stack Hub インスタンスごとに個別のストレージを考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-292">But you should consider independent storage per Azure Stack Hub instance in your application design.</span></span> <span data-ttu-id="87c5b-293">この設計が Azure Stack Hub へのソリューションのデプロイに対する懸念事項または障害である場合、ストレージの添付を提供する Microsoft パートナーのソリューションがあります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-293">If this design is a concern or road block to deploying the solution on Azure Stack Hub, there are possible solutions from Microsoft Partners that provide storage attachments.</span></span> <span data-ttu-id="87c5b-294">ストレージの添付により、複数の Azure Stack Hub と Azure 間にストレージ レプリケーション ソリューションが提供されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-294">Storage attachments provide a storage replication solution across multiple Azure Stack Hubs and Azure.</span></span> <span data-ttu-id="87c5b-295">詳細については、「[パートナー ソリューション](#partner-solutions)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-295">For more information, see the [Partner solutions](#partner-solutions).</span></span>

<span data-ttu-id="87c5b-296">このアーキテクチャでは、以下のレイヤーを検討しました。</span><span class="sxs-lookup"><span data-stu-id="87c5b-296">In our architecture, these layers were considered:</span></span>

<span data-ttu-id="87c5b-297">**Configuration**</span><span class="sxs-lookup"><span data-stu-id="87c5b-297">**Configuration**</span></span>

<span data-ttu-id="87c5b-298">構成には、Azure Stack Hub、AKS エンジン、および Kubernetes クラスター自体の構成が含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-298">Configuration includes the configuration of Azure Stack Hub, AKS Engine, and the Kubernetes cluster itself.</span></span> <span data-ttu-id="87c5b-299">構成は、可能な限り自動化し、Azure DevOps や GitHub などの Git ベースのバージョン コントロール システムにコードとしてのインフラストラクチャとして格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-299">The configuration should be automated as much as possible, and stored as Infrastructure-as-Code in a Git-based version control system like Azure DevOps or GitHub.</span></span> <span data-ttu-id="87c5b-300">これらの設定を複数のデプロイ間で簡単に同期することはできません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-300">These settings cannot easily be synchronized across multiple deployments.</span></span> <span data-ttu-id="87c5b-301">そのため、構成を外部から保存および適用し、DevOps パイプラインを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-301">Therefore we recommend storing and applying configuration from the outside, and using DevOps pipeline.</span></span>

<span data-ttu-id="87c5b-302">**アプリケーション**。</span><span class="sxs-lookup"><span data-stu-id="87c5b-302">**Application**</span></span>

<span data-ttu-id="87c5b-303">アプリケーションは、Git ベースのリポジトリに格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-303">The application should be stored in a Git-based repository.</span></span> <span data-ttu-id="87c5b-304">新しいデプロイがある場合、アプリケーションに変更を加えた場合、またはディザスター リカバリーを行う場合は、Azure Pipelines を使用して簡単にデプロイできます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-304">Whenever there's a new deployment, changes to the application, or disaster recovery, it can be easily deployed using Azure Pipelines.</span></span>

<span data-ttu-id="87c5b-305">**データ**</span><span class="sxs-lookup"><span data-stu-id="87c5b-305">**Data**</span></span>

<span data-ttu-id="87c5b-306">データは、ほとんどのアプリケーション設計で最も重要な考慮事項です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-306">Data is the most important consideration in most application designs.</span></span> <span data-ttu-id="87c5b-307">アプリケーション データは、アプリケーションの異なるインスタンス間で同期されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-307">Application data must stay in sync between the different instances of the application.</span></span> <span data-ttu-id="87c5b-308">また、障害が発生した場合に備えて、データのバックアップとディザスター リカバリーの戦略も必要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-308">Data also needs a backup and disaster recovery strategy if there's an outage.</span></span>

<span data-ttu-id="87c5b-309">この設計の実現は、テクノロジの選択に大きく依存します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-309">Achieving this design depends heavily on technology choices.</span></span> <span data-ttu-id="87c5b-310">Azure Stack Hub 上で可用性の高い方法でデータベースを実装するためのソリューション例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-310">Here are some solution examples for implementing a database in a highly available fashion on Azure Stack Hub:</span></span>

- [<span data-ttu-id="87c5b-311">Azure と Azure Stack Hub に SQL Server 2016 可用性グループをデプロイする</span><span class="sxs-lookup"><span data-stu-id="87c5b-311">Deploy a SQL Server 2016 availability group to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-sql-ha)
- [<span data-ttu-id="87c5b-312">高可用性の MongoDB ソリューションを Azure と Azure Stack Hub にデプロイする</span><span class="sxs-lookup"><span data-stu-id="87c5b-312">Deploy a highly available MongoDB solution to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-mongodb-ha)

<span data-ttu-id="87c5b-313">複数の場所でデータを操作する場合の考慮事項は、可用性と回復性が高いソリューションではさらに複雑な考慮事項です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-313">Considerations when working with data across multiple locations is an even more complex consideration for a highly available and resilient solution.</span></span> <span data-ttu-id="87c5b-314">次の点を考慮してください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-314">Consider:</span></span>

- <span data-ttu-id="87c5b-315">Azure Stack Hub 間の待機時間とネットワーク接続。</span><span class="sxs-lookup"><span data-stu-id="87c5b-315">Latency and network connectivity between Azure Stack Hubs.</span></span>
- <span data-ttu-id="87c5b-316">サービスとアクセス許可のための ID の可用性。</span><span class="sxs-lookup"><span data-stu-id="87c5b-316">Availability of identities for services and permissions.</span></span> <span data-ttu-id="87c5b-317">各 Azure Stack Hub インスタンスは、外部ディレクトリと統合されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-317">Each Azure Stack Hub instance integrates with an external directory.</span></span> <span data-ttu-id="87c5b-318">デプロイ時に、Azure Active Directory (Azure AD) または Active Directory フェデレーション サービス (ADFS) のどちらを使用するかを選択します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-318">During deployment, you choose to use either Azure Active Directory (Azure AD) or Active Directory Federation Services (ADFS).</span></span> <span data-ttu-id="87c5b-319">そのため、複数の独立した Azure Stack Hub インスタンスと対話できる 1 つの ID を使用する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-319">As such, there's potential to use a single identity that can interact with multiple independent Azure Stack Hub instances.</span></span>

## <a name="business-continuity-and-disaster-recovery"></a><span data-ttu-id="87c5b-320">事業継続とディザスター リカバリー</span><span class="sxs-lookup"><span data-stu-id="87c5b-320">Business continuity and disaster recovery</span></span>

<span data-ttu-id="87c5b-321">事業継続とディザスター リカバリー (BCDR) は、Azure Stack Hub と Azure の両方で重要なトピックです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-321">Business continuity and disaster recovery (BCDR) is an important topic in both Azure Stack Hub and Azure.</span></span> <span data-ttu-id="87c5b-322">主な違いは、Azure Stack Hub ではオペレーターが BCDR プロセス全体を管理する必要があることです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-322">The main difference is that in Azure Stack Hub, the operator must manage the whole BCDR process.</span></span> <span data-ttu-id="87c5b-323">Azure では、BCDR の一部が Microsoft によって自動的に管理されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-323">In Azure, parts of BCDR are automatically managed by Microsoft.</span></span>

<span data-ttu-id="87c5b-324">BCDR は、前のセクション「[データとストレージに関する考慮事項](#data-and-storage-considerations)」で説明したのと同じ領域に影響を与えます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-324">BCDR affects the same areas mentioned in the previous section [Data and storage considerations](#data-and-storage-considerations):</span></span>

- <span data-ttu-id="87c5b-325">インフラストラクチャと構成</span><span class="sxs-lookup"><span data-stu-id="87c5b-325">Infrastructure / Configuration</span></span>
- <span data-ttu-id="87c5b-326">アプリケーションの可用性</span><span class="sxs-lookup"><span data-stu-id="87c5b-326">Application Availability</span></span>
- <span data-ttu-id="87c5b-327">アプリケーション データ</span><span class="sxs-lookup"><span data-stu-id="87c5b-327">Application Data</span></span>

<span data-ttu-id="87c5b-328">前のセクションで説明したように、これらの領域は Azure Stack Hub オペレーターの担当であり、組織によって異なる場合があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-328">And as mentioned in the previous section, these areas are the responsibility of the Azure Stack Hub operator and can vary between organizations.</span></span> <span data-ttu-id="87c5b-329">使用可能なツールとプロセスに従って BCDR を計画します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-329">Plan BCDR according to your available tools and processes.</span></span>

<span data-ttu-id="87c5b-330">**インフラストラクチャと構成**</span><span class="sxs-lookup"><span data-stu-id="87c5b-330">**Infrastructure and configuration**</span></span>

<span data-ttu-id="87c5b-331">このセクションでは、Azure Stack Hub の物理的および論理的なインフラストラクチャと構成について説明します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-331">This section covers the physical and logical infrastructure and the configuration of Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-332">管理およびテナント スペースでの操作について説明します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-332">It covers actions in the admin and the tenant spaces.</span></span>

<span data-ttu-id="87c5b-333">Azure Stack Hub オペレーター (または管理者) は、Azure Stack Hub インスタンスのメンテナンスを担当します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-333">The Azure Stack Hub operator (or administrator) is responsible for maintenance of the Azure Stack Hub instances.</span></span> <span data-ttu-id="87c5b-334">ネットワーク、ストレージ、ID などのコンポーネントと、この記事の範囲外のその他のトピックが含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-334">Including components such as the network, storage, identity, and other topics that are outside the scope of this article.</span></span> <span data-ttu-id="87c5b-335">Azure Stack Hub の操作の詳細については、次のリソースをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-335">To learn more about the specifics of Azure Stack Hub operations, see the following resources:</span></span>

- [<span data-ttu-id="87c5b-336">Infrastructure Backup サービスを使用した Azure Stack Hub のデータの回復</span><span class="sxs-lookup"><span data-stu-id="87c5b-336">Recover data in Azure Stack Hub with the Infrastructure Backup Service</span></span>](/azure-stack/operator/azure-stack-backup-infrastructure-backup)
- [<span data-ttu-id="87c5b-337">管理者ポータルで Azure Stack Hub のバックアップを有効にする</span><span class="sxs-lookup"><span data-stu-id="87c5b-337">Enable backup for Azure Stack Hub from the administrator portal</span></span>](/azure-stack/operator/azure-stack-backup-enable-backup-console)
- [<span data-ttu-id="87c5b-338">致命的なデータ損失からの復旧</span><span class="sxs-lookup"><span data-stu-id="87c5b-338">Recover from catastrophic data loss</span></span>](/azure-stack/operator/azure-stack-backup-recover-data)
- [<span data-ttu-id="87c5b-339">インフラストラクチャ バックアップ サービスのベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="87c5b-339">Infrastructure Backup Service best practices</span></span>](/azure-stack/operator/azure-stack-backup-best-practices)

<span data-ttu-id="87c5b-340">Azure Stack Hub は、Kubernetes アプリケーションがデプロイされるプラットフォームでありファブリックです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-340">Azure Stack Hub is the platform and fabric on which Kubernetes applications will be deployed.</span></span> <span data-ttu-id="87c5b-341">Kubernetes アプリケーションのアプリケーション所有者は Azure Stack Hub のユーザーになり、ソリューションに必要なアプリケーション インフラストラクチャをデプロイするためのアクセス権が付与されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-341">The application owner for the Kubernetes application will be a user of Azure Stack Hub, with access granted to deploy the application infrastructure needed for the solution.</span></span> <span data-ttu-id="87c5b-342">この場合のアプリケーション インフラストラクチャは、AKS エンジンを使用してデプロイされた Kubernetes クラスターと、その周辺のサービスを意味します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-342">Application infrastructure in this case means the Kubernetes cluster, deployed using AKS Engine, and the surrounding services.</span></span> <span data-ttu-id="87c5b-343">これらのコンポーネントは Azure Stack Hub にデプロイされ、Azure Stack Hub オファーによって制約されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-343">These components will be deployed into Azure Stack Hub, constrained by an Azure Stack Hub offer.</span></span> <span data-ttu-id="87c5b-344">Kubernetes アプリケーション所有者が受け入れるオファーに、ソリューション全体をデプロイするのに十分な容量 (Azure Stack Hub クォータで表される) があることを確認します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-344">Make sure the offer accepted by the Kubernetes application owner has sufficient capacity (expressed in Azure Stack Hub quotas) to deploy the entire solution.</span></span> <span data-ttu-id="87c5b-345">前のセクションで推奨されているように、アプリケーションのデプロイは、コードとしてのインフラストラクチャと、Azure DevOps Azure Pipelines のようなデプロイ パイプラインを使用して自動化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-345">As recommended in the previous section, the application deployment should be automated using Infrastructure-as-Code and deployment pipelines like Azure DevOps Azure Pipelines.</span></span>

<span data-ttu-id="87c5b-346">Azure Stack Hub の詳細については、「[Azure Stack Hub サービス、プラン、オファー、サブスクリプションの概要](/azure-stack/operator/service-plan-offer-subscription-overview)」を参照してください</span><span class="sxs-lookup"><span data-stu-id="87c5b-346">For more information on Azure Stack Hub offers and quotas, see [Azure Stack Hub services, plans, offers, and subscriptions overview](/azure-stack/operator/service-plan-offer-subscription-overview)</span></span>

<span data-ttu-id="87c5b-347">AKS エンジンの構成は、その出力を含めて安全に保存し、格納することが重要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-347">It's important to securely save and store the AKS Engine configuration including its outputs.</span></span> <span data-ttu-id="87c5b-348">これらのファイルには、Kubernetes クラスターへのアクセスに使用される機密情報が含まれているため、管理者以外に公開されないように保護する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-348">These files contain confidential information used to access the Kubernetes cluster, so it must be protected from being exposed to non-administrators.</span></span>

<span data-ttu-id="87c5b-349">**アプリケーションの可用性**</span><span class="sxs-lookup"><span data-stu-id="87c5b-349">**Application availability**</span></span>

<span data-ttu-id="87c5b-350">デプロイされたインスタンスのバックアップにアプリケーションが依存しないようにしてください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-350">The application shouldn't rely on backups of a deployed instance.</span></span> <span data-ttu-id="87c5b-351">標準的な方法としては、コードとしてのインフラストラクチャ パターンに従ってアプリケーションを完全に再デプロイします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-351">As a standard practice, redeploy the application completely following Infrastructure-as-Code patterns.</span></span> <span data-ttu-id="87c5b-352">たとえば、Azure DevOps Azure Pipelines を使用して再デプロイします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-352">For example, redeploy using Azure DevOps Azure Pipelines.</span></span> <span data-ttu-id="87c5b-353">BCDR プロシージャでは、同じまたは別の Kubernetes クラスターにアプリケーションを再デプロイする必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-353">The BCDR procedure should involve the redeployment of the application to the same or another Kubernetes cluster.</span></span>

<span data-ttu-id="87c5b-354">**アプリケーション データ**</span><span class="sxs-lookup"><span data-stu-id="87c5b-354">**Application data**</span></span>

<span data-ttu-id="87c5b-355">アプリケーション データは、データの損失を最小限に抑えるための重要な部分です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-355">Application data is the critical part to minimize data loss.</span></span> <span data-ttu-id="87c5b-356">前のセクションでは、アプリケーションの 2 つ (またはそれ以上) のインスタンス間でデータをレプリケートおよび同期する手法について説明しました。</span><span class="sxs-lookup"><span data-stu-id="87c5b-356">In the previous section, techniques to replicate and synchronize data between two (or more) instances of the application were described.</span></span> <span data-ttu-id="87c5b-357">データの格納に使用されるデータベース インフラストラクチャ (MySQL、MongoDB、MSSQL など) によっては、さまざまなデータベース可用性とバックアップの手法から選択できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-357">Depending on the database infrastructure (MySQL, MongoDB, MSSQL or others) used to store the data, there will be different database availability and backup techniques available to choose from.</span></span>

<span data-ttu-id="87c5b-358">整合性を確保するには、次のいずれかの方法を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-358">The recommended ways to achieve integrity are to use either:</span></span>
- <span data-ttu-id="87c5b-359">特定のデータベースのネイティブ バックアップ ソリューション。</span><span class="sxs-lookup"><span data-stu-id="87c5b-359">A native backup solution for the specific database.</span></span>
- <span data-ttu-id="87c5b-360">アプリケーションで使用されるデータベースの種類のバックアップと回復を正式にサポートするバックアップ ソリューション。</span><span class="sxs-lookup"><span data-stu-id="87c5b-360">A backup solution that officially supports backup and recovery of the database type used by your application.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="87c5b-361">アプリケーション データが存在するのと同じ Azure Stack Hub インスタンスにバックアップ データを格納しないでください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-361">Do not store your backup data on the same Azure Stack Hub instance where your application data resides.</span></span> <span data-ttu-id="87c5b-362">Azure Stack Hub インスタンスが完全に停止すると、バックアップも危険にさらされます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-362">A complete outage of the Azure Stack Hub instance would also compromise your backups.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="87c5b-363">可用性に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-363">Availability considerations</span></span>

<span data-ttu-id="87c5b-364">AKS エンジンを介してデプロイされた Azure Stack Hub 上の Kubernetes は、マネージド サービスではありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-364">Kubernetes on Azure Stack Hub deployed via AKS Engine isn't a managed service.</span></span> <span data-ttu-id="87c5b-365">これは、Azure サービスとしてのインフラストラクチャ (IaaS) を使用した Kubernetes クラスターの自動化されたデプロイと構成です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-365">It's an automated deployment and configuration of a Kubernetes cluster using Azure Infrastructure-as-a-Service (IaaS).</span></span> <span data-ttu-id="87c5b-366">そのため、基になるインフラストラクチャと同じ可用性を提供します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-366">As such, it provides the same availability as the underlying infrastructure.</span></span>

<span data-ttu-id="87c5b-367">Azure Stack Hub インフラストラクチャは、既に障害に対する回復性があり、複数の[障害および更新ドメイン](/azure-stack/user/azure-stack-vm-considerations#high-availability)にコンポーネントを分散する可用性セットのような機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-367">Azure Stack Hub infrastructure is already resilient to failures, and provides capabilities like Availability Sets to distribute components across multiple [fault and update domains](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span></span> <span data-ttu-id="87c5b-368">しかし、基盤となっているテクノロジ (フェールオーバー クラスタリング) では、ハードウェアが故障した場合にその影響を受ける物理サーバー上の VM に多少のダウンタイムが発生します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-368">But the underlying technology (failover clustering) still incurs some downtime for VMs on an impacted physical server, if there's a hardware failure.</span></span>

<span data-ttu-id="87c5b-369">運用環境の Kubernetes クラスターに加えて、ワークロードを 2 つ (またはそれ以上) のクラスターにデプロイすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-369">It's a good practice to deploy your production Kubernetes cluster as well as the workload to two (or more) clusters.</span></span> <span data-ttu-id="87c5b-370">これらのクラスターは別の場所またはデータセンターにホストする必要があり、Azure Traffic Manager などのテクノロジを使用して、クラスターの応答時間に基づくか地理に基づいてユーザーをルーティングします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-370">These clusters should be hosted in different locations or datacenters, and use technologies like Azure Traffic Manager to route users based on cluster response time or based on geography.</span></span>

![Traffic Manager を使用したトラフィック フローの制御](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager.png)

<span data-ttu-id="87c5b-372">1 つだけの Kubernetes クラスターを持つお客様は、通常、特定のアプリケーションのサービス IP または DNS 名に接続します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-372">Customers who have a single Kubernetes cluster typically connect to the service IP or DNS name of a given application.</span></span> <span data-ttu-id="87c5b-373">複数クラスターのデプロイでは、各 Kubernetes クラスター上のサービスとイングレスを指す、Traffic Manager DNS 名に接続するようにしましょう。</span><span class="sxs-lookup"><span data-stu-id="87c5b-373">In a multi-cluster deployment, customers should connect to a Traffic Manager DNS name that points to the services/ingress on each Kubernetes cluster.</span></span>

![Traffic Manager を使用したオンプレミス クラスターへのルーティング](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager-on-premises.png)

> [!NOTE]
> <span data-ttu-id="87c5b-375">このパターンは、[Azure 内の (マネージド) AKS クラスター向けのベスト プラクティス](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment)でもあります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-375">This pattern is also a [best practice for (managed) AKS clusters in Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span></span>

<span data-ttu-id="87c5b-376">AKS エンジンを介してデプロイされる Kubernetes クラスター自体は、少なくとも 3 つのマスター ノードと 2 つのワーカー ノードで構成されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-376">The Kubernetes cluster itself, deployed via AKS Engine, should consist of at least three master nodes and two worker nodes.</span></span>

## <a name="identity-and-security-considerations"></a><span data-ttu-id="87c5b-377">ID とセキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-377">Identity and security considerations</span></span>

<span data-ttu-id="87c5b-378">ID とセキュリティは重要なトピックです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-378">Identity and security are important topics.</span></span> <span data-ttu-id="87c5b-379">ソリューションが独立した Azure Stack Hub インスタンスにまたがっている場合は特にそうです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-379">Especially when the solution spans independent Azure Stack Hub instances.</span></span> <span data-ttu-id="87c5b-380">Kubernetes と Azure (Azure Stack Hub を含む) のどちらにも、ロールベースのアクセス制御 (RBAC) について固有のメカニズムがあります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-380">Kubernetes and Azure (including Azure Stack Hub) both have distinct mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="87c5b-381">Azure RBAC により、Azure (および Azure Stack Hub) でのリソースへのアクセス (新しい Azure リソースを作成する機能を含む) が制御されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-381">Azure RBAC controls access to resources in Azure (and Azure Stack Hub), including the ability to create new Azure resources.</span></span> <span data-ttu-id="87c5b-382">アクセス許可は、ユーザー、グループ、またはサービス プリンシパルに割り当てることができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-382">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="87c5b-383">(サービス プリンシパルは、アプリケーションによって使用されるセキュリティ ID です。)</span><span class="sxs-lookup"><span data-stu-id="87c5b-383">(A service principal is a security identity used by applications.)</span></span>
- <span data-ttu-id="87c5b-384">Kubernetes RBAC は、Kubernetes API へのアクセス許可を制御します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-384">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="87c5b-385">たとえば、ポッドの作成やポッドの一覧表示は、RBAC によってユーザーに許可 (または拒否) できるアクションです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-385">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="87c5b-386">ユーザーに Kubernetes アクセス許可を割り当てるには、ロールとロール バインディングを作成します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-386">To assign Kubernetes permissions to users, you create roles and role bindings.</span></span>

<span data-ttu-id="87c5b-387">**Azure Stack Hub ID と RBAC**</span><span class="sxs-lookup"><span data-stu-id="87c5b-387">**Azure Stack Hub identity and RBAC**</span></span>

<span data-ttu-id="87c5b-388">Azure Stack Hub では、ID プロバイダーに 2 つの選択肢が用意されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-388">Azure Stack Hub provides two identity provider choices.</span></span> <span data-ttu-id="87c5b-389">使用するプロバイダーは、環境と、接続されている、または切断されている環境のどちらで実行するかによって決まります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-389">The provider you use depends on the environment and whether running in a connected or disconnected environment:</span></span>

- <span data-ttu-id="87c5b-390">Azure AD - 接続された環境でのみ使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-390">Azure AD - can only be used in a connected environment.</span></span>
- <span data-ttu-id="87c5b-391">従来の Active Directory フォレストへの ADFS - 接続されている、または切断されている環境のどちらでも使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-391">ADFS to a traditional Active Directory forest - can be used in both a connected or disconnected environment.</span></span>

<span data-ttu-id="87c5b-392">ID プロバイダーにより、ユーザーとグループが管理されます。これには、リソースにアクセスするための認証と認可が含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-392">The identity provider manages users and groups, including authentication and authorization for accessing resources.</span></span> <span data-ttu-id="87c5b-393">サブスクリプション、リソース グループ、VM やロード バランサーなどの個々のリソースのような Azure Stack Hub リソースへのアクセス権を付与することができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-393">Access can be granted to Azure Stack Hub resources like subscriptions, resource groups, and individual resources like VMs or load balancers.</span></span> <span data-ttu-id="87c5b-394">一貫性のあるアクセス モデルを使用するには、すべての Azure Stack Hub に同じグループ (直接または入れ子) を使用することを検討する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-394">To have a consistent access model, you should consider using the same groups (either direct or nested) for all Azure Stack Hubs.</span></span> <span data-ttu-id="87c5b-395">次に構成例を示します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-395">Here's a configuration example:</span></span>

![azure stack hub を使用した入れ子になった aad グループ](media/pattern-highly-available-kubernetes/azure-stack-azure-ad-nested-groups.png)

<span data-ttu-id="87c5b-397">この例には、特定の目的を持つ専用のグループ (AAD または ADFS を使用) が含まれています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-397">The example contains a dedicated group (using AAD or ADFS) for a specific purpose.</span></span> <span data-ttu-id="87c5b-398">たとえば、特定の Azure Stack Hub インスタンス (ここでは、"Seattle K8s Cluster Contributor") に Kubernetes クラスター インフラストラクチャを含むリソース グループに対する共同作成者のアクセス許可を付与します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-398">For example, to provide Contributor permissions for the Resource Group that contains our Kubernetes cluster infrastructure on a specific Azure Stack Hub instance (here "Seattle K8s Cluster Contributor").</span></span> <span data-ttu-id="87c5b-399">これらのグループは、各 Azure Stack Hub の "サブグループ" を含む全体グループに入れ子になっています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-399">These groups are then nested into an overall group that contains the "subgroups" for each Azure Stack Hub.</span></span>

<span data-ttu-id="87c5b-400">サンプル ユーザーには、Kubernetes インフラストラクチャ リソースのセット全体を含む両方のリソース グループに対する "共同作成者" アクセス許可が付与されました。</span><span class="sxs-lookup"><span data-stu-id="87c5b-400">Our sample user will now have "Contributor" permissions to both Resources Groups that contain the entire set of Kubernetes infrastructure resources.</span></span> <span data-ttu-id="87c5b-401">インスタンスは同じ ID プロバイダーを共有するので、ユーザーは両方の Azure Stack Hub インスタンス上のリソースにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-401">The user will have access to resources on both Azure Stack Hub instances, because the instances share the same identity provider.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="87c5b-402">これらのアクセス許可は、Azure Stack Hub と、その上にデプロイされた一部のリソースにのみ影響します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-402">These permissions affect only Azure Stack Hub and some of the resources deployed on top of it.</span></span> <span data-ttu-id="87c5b-403">このレベルのアクセス権を持つユーザーは、多くの問題を引き起こすことがありますが、Kubernetes デプロイに追加でアクセスすることなく Kubernetes IaaS VM や Kubernetes API にアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-403">A user who has this level of access can do a lot of harm, but cannot access the Kubernetes IaaS VMs nor the Kubernetes API without additional access to the Kubernetes deployment.</span></span>

<span data-ttu-id="87c5b-404">**Kubernetes ID と RBAC**</span><span class="sxs-lookup"><span data-stu-id="87c5b-404">**Kubernetes identity and RBAC**</span></span>

<span data-ttu-id="87c5b-405">既定では、Kubernetes クラスターは、基盤となる Azure Stack Hub と同じ ID プロバイダーを使用しません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-405">A Kubernetes cluster, by default, doesn't use the same Identity Provider as the underlaying Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-406">Kubernetes クラスター、マスター、およびワーカー ノードをホストしている VM は、クラスターのデプロイ時に指定された SSH キーを使用します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-406">The VMs hosting the Kubernetes cluster, the master, and worker nodes, use the SSH Key that is specified during the deployment of the cluster.</span></span> <span data-ttu-id="87c5b-407">この SSH キーは、SSH を使用してこれらのノードに接続するために必要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-407">This SSH key is required to connect to these nodes using SSH.</span></span>

<span data-ttu-id="87c5b-408">Kubernetes API (たとえば、`kubectl` を使用してアクセスされる) は、既定の "cluster admin" サービス アカウントを含むサービス アカウントによっても保護されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-408">The Kubernetes API (for example, accessed by using `kubectl`) is also protected by service accounts including a default "cluster admin" service account.</span></span> <span data-ttu-id="87c5b-409">このサービス アカウントの資格情報は、最初は Kubernetes マスター ノード上の `.kube/config` ファイルに格納されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-409">The credentials for this service account are initially stored in the `.kube/config` file on your Kubernetes master nodes.</span></span>

<span data-ttu-id="87c5b-410">**シークレットの管理とアプリケーションの資格情報**</span><span class="sxs-lookup"><span data-stu-id="87c5b-410">**Secrets management and application credentials**</span></span>

<span data-ttu-id="87c5b-411">接続文字列やデータベース資格情報などのシークレットを格納するには、次のようないくつかの選択肢があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-411">To store secrets like connection strings or database credentials there are several choices, including:</span></span>

- <span data-ttu-id="87c5b-412">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="87c5b-412">Azure Key Vault</span></span>
- <span data-ttu-id="87c5b-413">Kubernetes シークレット</span><span class="sxs-lookup"><span data-stu-id="87c5b-413">Kubernetes Secrets</span></span>
- <span data-ttu-id="87c5b-414">HashiCorp Vault のようなサードパーティ ソリューション (Kubernetes 上で実行)</span><span class="sxs-lookup"><span data-stu-id="87c5b-414">3rd-Party solutions like HashiCorp Vault (running on Kubernetes)</span></span>

<span data-ttu-id="87c5b-415">構成ファイル、アプリケーション コード、またはスクリプト内にシークレットや資格情報をプレーンテキストで保存しないでください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-415">Do not store secrets or credentials in plaintext in your configuration files, application code, or within scripts.</span></span> <span data-ttu-id="87c5b-416">また、バージョン コントロール システムには格納しないでください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-416">And do not store them in a version control system.</span></span> <span data-ttu-id="87c5b-417">代わりに、必要に応じてデプロイの自動化によってシークレットを取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-417">Instead, the deployment automation should retrieve the secrets as needed.</span></span>

## <a name="patch-and-update"></a><span data-ttu-id="87c5b-418">パッチと更新プログラム</span><span class="sxs-lookup"><span data-stu-id="87c5b-418">Patch and update</span></span>

<span data-ttu-id="87c5b-419">Azure Kubernetes Service の **パッチと更新プログラム (PNU)** プロセスは、部分的に自動化されています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-419">The **Patch and Update (PNU)** process in Azure Kubernetes Service is partially automated.</span></span> <span data-ttu-id="87c5b-420">Kubernetes バージョンのアップグレードは手動でトリガーされますが、セキュリティ更新プログラムは自動的に適用されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-420">Kubernetes version upgrades are triggered manually, while security updates are applied automatically.</span></span> <span data-ttu-id="87c5b-421">これらの更新プログラムには、OS のセキュリティ修正プログラムやカーネルの更新プログラムが含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-421">These updates can include OS security fixes or kernel updates.</span></span> <span data-ttu-id="87c5b-422">AKS は、更新プロセスを完了するためにこれらの Linux ノードを自動的に再起動しません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-422">AKS doesn't automatically reboot these Linux nodes to complete the update process.</span></span> 

<span data-ttu-id="87c5b-423">Azure Stack Hub 上で AKS エンジンを使用してデプロイされた Kubernetes クラスターの場合、PNU プロセスは管理されません。これは、クラスター オペレーターが担当します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-423">The PNU process for a Kubernetes cluster deployed using AKS Engine on Azure Stack Hub is unmanaged, and is the responsibility of the cluster operator.</span></span> 

<span data-ttu-id="87c5b-424">AKS エンジンは、2 つの最も重要なタスクに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-424">AKS Engine helps with the two most important tasks:</span></span>

- [<span data-ttu-id="87c5b-425">新しい Kubernetes とベース OS イメージ バージョンへのアップグレード</span><span class="sxs-lookup"><span data-stu-id="87c5b-425">Upgrade to a newer Kubernetes and base OS image version</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-upgrade-to-a-newer-kubernetes-version)
- [<span data-ttu-id="87c5b-426">ベース OS イメージのみのアップグレード</span><span class="sxs-lookup"><span data-stu-id="87c5b-426">Upgrade the base OS image only</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-only-upgrade-the-os-image)

<span data-ttu-id="87c5b-427">新しいベース OS イメージには、最新の OS セキュリティ修正プログラムとカーネル更新プログラムが含まれています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-427">Newer base OS images contain the latest OS security fixes and kernel updates.</span></span> 

<span data-ttu-id="87c5b-428">[無人アップグレード](https://wiki.debian.org/UnattendedUpgrades) メカニズムでは、新しいベース OS イメージ バージョンを Azure Stack Hub Marketplace で利用できるようになる前にリリースされたセキュリティ更新プログラムが自動的にインストールされます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-428">The [Unattended Upgrade](https://wiki.debian.org/UnattendedUpgrades) mechanism automatically installs security updates that are released before a new base OS image version is available in the Azure Stack Hub Marketplace.</span></span> <span data-ttu-id="87c5b-429">無人アップグレードは既定で有効になっており、セキュリティ更新プログラムは自動的にインストールされますが、Kubernetes クラスター ノードは再起動されません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-429">Unattended upgrade is enabled by default and installs security updates automatically, but does not reboot the Kubernetes cluster nodes.</span></span> <span data-ttu-id="87c5b-430">ノードの再起動は、オープンソースの [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured) を使用して自動化できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-430">Rebooting the nodes can be automated using the open-source [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured).</span></span> <span data-ttu-id="87c5b-431">Kured によって、再起動を必要とする Linux ノードが監視され、ポッドの実行とノードの再起動プロセスの再スケジュールが自動的に処理されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-431">Kured watches for Linux nodes that require a reboot, then automatically handle the rescheduling of running pods and node reboot process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="87c5b-432">デプロイ (CI/CD) に関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="87c5b-432">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="87c5b-433">Azure と Azure Stack Hub では同じ Azure Resource Manager REST API が公開されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-433">Azure and Azure Stack Hub expose the same Azure Resource Manager REST APIs.</span></span> <span data-ttu-id="87c5b-434">これらの API は、他の Azure クラウド (Azure、Azure China 21Vianet、Azure Government) と同様に対処されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-434">These APIs are addressed like any other Azure cloud (Azure, Azure China 21Vianet, Azure Government).</span></span> <span data-ttu-id="87c5b-435">クラウド間の API バージョンに違いがある可能性があり、Azure Stack Hub ではサービスのサブセットのみが提供されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-435">There may be differences in API versions between clouds, and Azure Stack Hub provides only a subset of services.</span></span> <span data-ttu-id="87c5b-436">また、管理エンドポイントの URI は、クラウドごと、および Azure Stack Hub のインスタンスごとに異なります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-436">The management endpoint URI is also different for each cloud, and each instance of Azure Stack Hub.</span></span>

<span data-ttu-id="87c5b-437">ここで説明した微妙な違いを除けば、Azure Resource Manager REST API によって、Azure と Azure Stack Hub の両方と対話するための一貫した方法が提供されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-437">Aside from the subtle differences mentioned, Azure Resource Manager REST APIs provide a consistent way to interact with both Azure and Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-438">ここでは、他の Azure クラウドで使用したものと同じツール セットを使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-438">The same set of tools can be used here as would be used with any other Azure cloud.</span></span> <span data-ttu-id="87c5b-439">Azure DevOps、Jenkins などのツール、または PowerShell を使用して、サービスを Azure Stack Hub にデプロイし、オーケストレーションを行うことができます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-439">You can use Azure DevOps, tools like Jenkins, or PowerShell, to deploy and orchestrate services to Azure Stack Hub.</span></span>

<span data-ttu-id="87c5b-440">**考慮事項**</span><span class="sxs-lookup"><span data-stu-id="87c5b-440">**Considerations**</span></span>

<span data-ttu-id="87c5b-441">Azure Stack Hub のデプロイに関する大きな違いの 1 つは、インターネット アクセシビリティの問題です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-441">One of the major differences when it comes to Azure Stack Hub deployments is the question of Internet accessibility.</span></span> <span data-ttu-id="87c5b-442">インターネット アクセシビリティによって、CI/CD ジョブに対して、Microsoft ホステッドとセルフホステッド のどちらのビルド エージェントを選択するかが決まります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-442">Internet accessibility determines whether to select a Microsoft-hosted or a self-hosted build agent for your CI/CD jobs.</span></span>

<span data-ttu-id="87c5b-443">セルフホステッド エージェントは、Azure Stack Hub の上で (IaaS VM として)、または Azure Stack Hub にアクセスできるネットワーク サブネット内で実行できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-443">A self-hosted agent can run on top of Azure Stack Hub (as an IaaS VM) or in a network subnet that can access Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-444">相違点の詳細については、「[Azure Pipelines エージェント](/azure/devops/pipelines/agents/agents)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-444">Go to [Azure Pipelines agents](/azure/devops/pipelines/agents/agents) to learn more about the differences.</span></span>

<span data-ttu-id="87c5b-445">次の図は、セルフホステッドまたは Microsoft ホステッドのどちらのビルド エージェントが必要かを判断するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-445">The following image helps you to decide if you need a self-hosted or a Microsoft-hosted build agent:</span></span>

![セルフホステッド ビルド エージェント。はいまたはいいえ](media/pattern-highly-available-kubernetes/aks-on-stack-self-hosted-build-agents-yes-or-no.png)

- <span data-ttu-id="87c5b-447">Azure Stack Hub 管理エンドポイントは、インターネット経由でアクセスできますか。</span><span class="sxs-lookup"><span data-stu-id="87c5b-447">Are the Azure Stack Hub management endpoints accessible via Internet?</span></span>
  - <span data-ttu-id="87c5b-448">はい:Microsoft ホステッド エージェントと共に Azure Pipelines を使用して、Azure Stack Hub に接続できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-448">Yes: We can use Azure Pipelines with Microsoft-hosted agents to connect to Azure Stack Hub.</span></span>
  - <span data-ttu-id="87c5b-449">いいえ:Azure Stack Hub の管理エンドポイントに接続できるセルフホステッド エージェントが必要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-449">No: We need self-hosted agents that can connect to Azure Stack Hub's management endpoints.</span></span>
- <span data-ttu-id="87c5b-450">Kubernetes クラスターにはインターネット経由でアクセスできますか。</span><span class="sxs-lookup"><span data-stu-id="87c5b-450">Is our Kubernetes cluster accessible via the Internet?</span></span>
  - <span data-ttu-id="87c5b-451">はい:Microsoft ホステッド エージェントと共に Azure Pipelines を使用して、Kubernetes API エンドポイントと直接対話できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-451">Yes: We can use Azure Pipelines with Microsoft-hosted agents to interact directly with Kubernetes API endpoint.</span></span>
  - <span data-ttu-id="87c5b-452">いいえ:Kubernetes クラスター API エンドポイントに接続できるセルフホステッド エージェントが必要です。</span><span class="sxs-lookup"><span data-stu-id="87c5b-452">No: We need self-hosted Agents that can connect to the Kubernetes cluster API endpoint.</span></span>

<span data-ttu-id="87c5b-453">インターネット経由で Azure Stack Hub 管理エンドポイントと Kubernetes API にアクセスできるシナリオでは、デプロイに Microsoft ホステッド エージェントを使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-453">In scenarios where the Azure Stack Hub management endpoints and Kubernetes API are accessible via the internet, the deployment can use a Microsoft-hosted agent.</span></span> <span data-ttu-id="87c5b-454">このデプロイを実行すると、アプリケーション アーキテクチャは次のようになります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-454">This deployment will result in an application architecture as follows:</span></span>

<span data-ttu-id="87c5b-455">[![パブリック アーキテクチャの概要](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="87c5b-455">[![Public architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span></span>

<span data-ttu-id="87c5b-456">Azure Resource Manager エンドポイント、Kubernetes API、またはその両方がインターネット経由で直接アクセスできない場合は、セルフホステッド ビルド エージェントを利用してパイプラインのステップを実行できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-456">If the Azure Resource Manager endpoints, Kubernetes API, or both aren't directly accessible via the Internet, we can leverage a self-hosted build agent to run the pipeline steps.</span></span> <span data-ttu-id="87c5b-457">この設計では、必要な接続が少なく、Azure Resource Manager エンドポイントと Kubernetes API へのオンプレミス ネットワーク接続のみを使用してデプロイできます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-457">This design needs less connectivity, and can be deployed with only on-premises network connectivity to Azure Resource Manager endpoints and the Kubernetes API:</span></span>

<span data-ttu-id="87c5b-458">[![オンプレミス アーキテクチャの概要](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="87c5b-458">[![On-prem architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span></span>

> [!NOTE]
> <span data-ttu-id="87c5b-459">**切断されたシナリオについて**</span><span class="sxs-lookup"><span data-stu-id="87c5b-459">**What about disconnected scenarios?**</span></span> <span data-ttu-id="87c5b-460">Azure Stack Hub、Kubernetes、またはその両方がインターネットに接続された管理エンドポイントを持たないシナリオでも、デプロイに Azure DevOps を使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-460">In scenarios where either Azure Stack Hub or Kubernetes or both of them do not have internet-facing management endpoints, it is still possible to use Azure DevOps for your deployments.</span></span> <span data-ttu-id="87c5b-461">セルフホステッド エージェント プール (オンプレミスまたは Azure Stack Hub 自体で実行されている DevOps エージェント)、またはオンプレミスの完全にセルフホステッドの Azure DevOps Server を使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-461">You can either use a self-hosted Agent Pool (which is a DevOps Agent running on-premises or on Azure Stack Hub itself) or a completly self-hosted Azure DevOps Server on-premises.</span></span> <span data-ttu-id="87c5b-462">セルフホステッド エージェントは、送信 HTTPS (TCP/443) インターネット接続のみを必要とします。</span><span class="sxs-lookup"><span data-stu-id="87c5b-462">The self-hosted agent needs only outbound HTTPS (TCP/443) Internet connectivity.</span></span>

<span data-ttu-id="87c5b-463">このパターンでは、各 Azure Stack Hub インスタンス上で Kubernetes クラスター (AKS エンジンを使用してデプロイおよび調整) を使用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-463">The pattern can use a Kubernetes cluster (deployed and orchestrated with AKS engine) on each Azure Stack Hub instance.</span></span> <span data-ttu-id="87c5b-464">これには、フロントエンド、中間層、バックエンド サービス (MongoDB など)、および nginx ベースのイングレス コントローラーで構成されるアプリケーションが含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-464">It includes an application consisting of a frontend, a mid-tier, backend services (for example MongoDB), and an nginx-based Ingress Controller.</span></span> <span data-ttu-id="87c5b-465">K8s クラスターにホストされているデータベースを使用する代わりに、"外部データ ストア" を利用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-465">Instead of using a database hosted on the K8s cluster, you can leverage "external data stores".</span></span> <span data-ttu-id="87c5b-466">データベース オプションには、MySQL、SQL Server、または Azure Stack Hub の外部か IaaS 内にホストされている任意の種類のデータベースが含まれます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-466">Database options include MySQL, SQL Server, or any kind of database hosted outside of Azure Stack Hub or in IaaS.</span></span> <span data-ttu-id="87c5b-467">このような構成は、ここでは扱いません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-467">Configurations like this aren't in scope here.</span></span>

## <a name="partner-solutions"></a><span data-ttu-id="87c5b-468">パートナー ソリューション</span><span class="sxs-lookup"><span data-stu-id="87c5b-468">Partner solutions</span></span>

<span data-ttu-id="87c5b-469">Azure Stack Hub の機能を拡張できる Microsoft パートナー ソリューションがあります。</span><span class="sxs-lookup"><span data-stu-id="87c5b-469">There are Microsoft Partner solutions that can extend the capabilities of Azure Stack Hub.</span></span> <span data-ttu-id="87c5b-470">これらのソリューションは、Kubernetes クラスター上で実行されているアプリケーションのデプロイに役立つことがわかっています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-470">These solutions have been found useful in deployments of applications running on Kubernetes clusters.</span></span>  

## <a name="storage-and-data-solutions"></a><span data-ttu-id="87c5b-471">ストレージとデータのソリューション</span><span class="sxs-lookup"><span data-stu-id="87c5b-471">Storage and data solutions</span></span>

<span data-ttu-id="87c5b-472">「[データとストレージに関する考慮事項](#data-and-storage-considerations)」で説明したように、現在 Azure Stack Hub には、複数のインスタンスにストレージをレプリケートするためのネイティブ ソリューションがありません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-472">As described in [Data and storage considerations](#data-and-storage-considerations), Azure Stack Hub currently doesn't have a native solution to replicate storage across multiple instances.</span></span> <span data-ttu-id="87c5b-473">Azure とは異なり、複数のリージョンにわたってストレージをレプリケートする機能は存在しません。</span><span class="sxs-lookup"><span data-stu-id="87c5b-473">Unlike Azure, the capability of replicating storage across multiple regions does not exist.</span></span> <span data-ttu-id="87c5b-474">Azure Stack Hub では、各インスタンスは独自の個別クラウドです。</span><span class="sxs-lookup"><span data-stu-id="87c5b-474">In Azure Stack Hub, each instance is its own distinct cloud.</span></span> <span data-ttu-id="87c5b-475">ただし、Azure Stack Hub と Azure 間でのストレージ レプリケーションを可能にする Microsoft パートナーのソリューションを利用できます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-475">However, solutions are available from Microsoft Partners that enable storage replication across Azure Stack Hubs and Azure.</span></span> 

<span data-ttu-id="87c5b-476">**SCALITY**</span><span class="sxs-lookup"><span data-stu-id="87c5b-476">**SCALITY**</span></span>

<span data-ttu-id="87c5b-477">[Scality](https://www.scality.com/) では、2009 年以降、デジタル ビジネスを強化した Web スケール ストレージを提供しています。</span><span class="sxs-lookup"><span data-stu-id="87c5b-477">[Scality](https://www.scality.com/) delivers web-scale storage that has powered digital businesses since 2009.</span></span> <span data-ttu-id="87c5b-478">Microsoft のソフトウェアで定義されたストレージである Scality RING は、商用 x86 サーバーを、ペタバイト規模のあらゆる種類のデータ (ファイルとオブジェクト) 用の無制限のストレージ プールに変換します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-478">The Scality RING, our software-defined storage, turns commodity x86 servers into an unlimited storage pool for any type of data –file and object– at petabyte scale.</span></span>

<span data-ttu-id="87c5b-479">**CLOUDIAN**</span><span class="sxs-lookup"><span data-stu-id="87c5b-479">**CLOUDIAN**</span></span>

<span data-ttu-id="87c5b-480">[Cloudian](https://www.cloudian.com/) では、大規模なデータ セットを 1 つの簡単に管理できる環境に統合する無制限の拡張性を備えたストレージを使用して、エンタープライズ ストレージが簡素化されます。</span><span class="sxs-lookup"><span data-stu-id="87c5b-480">[Cloudian](https://www.cloudian.com/) simplifies enterprise storage with limitless scalable storage that consolidates massive data sets to a single, easily managed environment.</span></span>

## <a name="next-steps"></a><span data-ttu-id="87c5b-481">次のステップ</span><span class="sxs-lookup"><span data-stu-id="87c5b-481">Next steps</span></span>

<span data-ttu-id="87c5b-482">この記事で紹介した概念の関連情報:</span><span class="sxs-lookup"><span data-stu-id="87c5b-482">To learn more about concepts introduced in this article:</span></span>

- <span data-ttu-id="87c5b-483">Azure Stack Hub 内での[クラウド間スケーリング](pattern-cross-cloud-scale.md)および[地理的に分散されたアプリ パターン](pattern-geo-distributed.md)。</span><span class="sxs-lookup"><span data-stu-id="87c5b-483">[Cross-cloud scaling](pattern-cross-cloud-scale.md) and [Geo-distributed app patterns](pattern-geo-distributed.md) in Azure Stack Hub.</span></span>
- <span data-ttu-id="87c5b-484">[Azure Kubernetes Service (AKS) 上のマイクロサービス アーキテクチャ](/azure/architecture/reference-architectures/microservices/aks)。</span><span class="sxs-lookup"><span data-stu-id="87c5b-484">[Microservices architecture on Azure Kubernetes Service (AKS)](/azure/architecture/reference-architectures/microservices/aks).</span></span>

<span data-ttu-id="87c5b-485">ソリューションの例をテストする準備ができたら、[高可用性 Kubernetes クラスター デプロイ ガイド](solution-deployment-guide-highly-available-kubernetes.md)に進んでください。</span><span class="sxs-lookup"><span data-stu-id="87c5b-485">When you're ready to test the solution example, continue with the [High availability Kubernetes cluster deployment guide](solution-deployment-guide-highly-available-kubernetes.md).</span></span> <span data-ttu-id="87c5b-486">デプロイ ガイドでは、コンポーネントをデプロイしてテストするための詳細な手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="87c5b-486">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>