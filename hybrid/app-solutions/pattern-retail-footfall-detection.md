---
title: Azure と Azure Stack Hub を使用した足取り検出パターン
description: Azure および Azure Stack Hub を使用して AI ベースの足取り検出ソリューションを実装し、小売店内のトラフィックを分析する方法について説明します。
author: BryanLa
ms.topic: article
ms.date: 10/31/2019
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 10/31/2019
ms.openlocfilehash: 866557ec3af2337e9f034da84cf417675508563b
ms.sourcegitcommit: 962334135b63ac99c715e7bc8fb9282648ba63c9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/23/2021
ms.locfileid: "104895331"
---
# <a name="footfall-detection-pattern"></a><span data-ttu-id="bd5a2-103">足取り検出パターン</span><span class="sxs-lookup"><span data-stu-id="bd5a2-103">Footfall detection pattern</span></span>

<span data-ttu-id="bd5a2-104">このパターンでは、小売店で買い物客のトラフィックを分析するために、AI ベースの足取り検出ソリューションを実装するための概要を提供します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-104">This pattern provides an overview for implementing an AI-based footfall detection solution for analyzing visitor traffic in retail stores.</span></span> <span data-ttu-id="bd5a2-105">このソリューションでは、Azure、Azure Stack Hub、Custom Vision AI Dev Kit を使用して、実際の行動から分析情報を生成します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-105">The solution generates insights from real world actions, using Azure, Azure Stack Hub, and the Custom Vision AI Dev Kit.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="bd5a2-106">コンテキストと問題</span><span class="sxs-lookup"><span data-stu-id="bd5a2-106">Context and problem</span></span>

<span data-ttu-id="bd5a2-107">Contoso Stores では、店舗のレイアウトに関連して、顧客が現在の製品をどのように受け取っているかについて分析情報を得たいと考えています。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-107">Contoso Stores would like to gain insights on how customers are receiving their current products in relation to store layout.</span></span> <span data-ttu-id="bd5a2-108">すべてのセクションにスタッフを配置することはできません。また、カメラ撮影した店舗内の映像すべてをアナリスト チームに確認してもらうのも非効率です。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-108">They're unable to place staff in every section and it's inefficient to have a team of analysts review an entire store's camera footage.</span></span> <span data-ttu-id="bd5a2-109">さらに、分析用の映像をすべてのカメラからクラウドにストリーミングできるだけの十分な帯域幅は、どの店舗にもありません。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-109">In addition, none of their stores have enough bandwidth to stream video from all their cameras to the cloud for analysis.</span></span>

<span data-ttu-id="bd5a2-110">Contoso では、顧客の人口統計、ロイヤルティ、店舗のディスプレイと製品に対する反応を確認するための、邪魔にならずプライバシーに配慮した方法を見つけたいと考えています。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-110">Contoso would like to find an unobtrusive, privacy-friendly way to determine their customers' demographics, loyalty, and reactions to store displays and products.</span></span>

## <a name="solution"></a><span data-ttu-id="bd5a2-111">ソリューション</span><span class="sxs-lookup"><span data-stu-id="bd5a2-111">Solution</span></span>

<span data-ttu-id="bd5a2-112">この小売分析パターンでは、階層型アプローチを使用してエッジで推論を行います。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-112">This retail analytics pattern uses a tiered approach to inferencing at the edge.</span></span> <span data-ttu-id="bd5a2-113">Custom Vision AI Dev Kit を使用することで、人の顔が含まれる画像のみが、分析のためにプライベート Azure Stack Hub に送信されます。Azure Stack Hub では、Azure Cognitive Services が実行されています。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-113">By using the Custom Vision AI Dev Kit, only images with human faces are sent for analysis to a private Azure Stack Hub that runs Azure Cognitive Services.</span></span> <span data-ttu-id="bd5a2-114">集計された匿名データが Azure に送信され、すべての店舗にわたって集計されて Power BI で視覚化されます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-114">Anonymized, aggregated data is sent to Azure for aggregation across all stores and visualization in Power BI.</span></span> <span data-ttu-id="bd5a2-115">エッジとパブリック クラウドを組み合わせることにより、Contoso は最新の AI テクノロジを活用しながら、企業のポリシーに準拠し、顧客のプライバシーを尊重することができます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-115">Combining the edge and public cloud lets Contoso take advantage of modern AI technology while also remaining in compliance with their corporate policies and respecting their customers' privacy.</span></span>

<span data-ttu-id="bd5a2-116">[![足取り検出パターン ソリューション](media/pattern-retail-footfall-detection/solution-architecture.png)](media/pattern-retail-footfall-detection/solution-architecture.png)</span><span class="sxs-lookup"><span data-stu-id="bd5a2-116">[![Footfall detection pattern solution](media/pattern-retail-footfall-detection/solution-architecture.png)](media/pattern-retail-footfall-detection/solution-architecture.png)</span></span>

<span data-ttu-id="bd5a2-117">このソリューションのしくみの概要を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-117">Here's a summary of how the solution works:</span></span>

1. <span data-ttu-id="bd5a2-118">Custom Vision AI Dev Kit は IoT Hub から構成を取得します。これにより IoT Edge ランタイムと ML モデルがインストールされます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-118">The Custom Vision AI Dev Kit gets a configuration from IoT Hub, which installs the IoT Edge Runtime and an ML model.</span></span>
2. <span data-ttu-id="bd5a2-119">モデルが人を認識すると、写真が撮影され、Azure Stack Hub BLOB ストレージにアップロードされます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-119">If the model sees a person, it takes a picture and uploads it to Azure Stack Hub blob storage.</span></span>
3. <span data-ttu-id="bd5a2-120">Blob service によって Azure Stack Hub で Azure 関数がトリガーされます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-120">The blob service triggers an Azure Function on Azure Stack Hub.</span></span>
4. <span data-ttu-id="bd5a2-121">Azure 関数は、Face API を含むコンテナーを呼び出し、画像から人口統計データと感情データを取得します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-121">The Azure Function calls a container with the Face API to get demographic and emotion data from the image.</span></span>
5. <span data-ttu-id="bd5a2-122">このデータは匿名化され、Azure Event Hubs クラスターに送信されます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-122">The data is anonymized and sent to an Azure Event Hubs cluster.</span></span>
6. <span data-ttu-id="bd5a2-123">Event Hubs クラスターにより、データは Stream Analytics にプッシュされます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-123">The Event Hubs cluster pushes the data to Stream Analytics.</span></span>
7. <span data-ttu-id="bd5a2-124">Stream Analytics によってデータが集計され、Power BI にプッシュされます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-124">Stream Analytics aggregates the data and pushes it to Power BI.</span></span>

## <a name="components"></a><span data-ttu-id="bd5a2-125">Components</span><span class="sxs-lookup"><span data-stu-id="bd5a2-125">Components</span></span>

<span data-ttu-id="bd5a2-126">このソリューションでは、次のコンポーネントを使用します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-126">This solution uses the following components:</span></span>

| <span data-ttu-id="bd5a2-127">レイヤー</span><span class="sxs-lookup"><span data-stu-id="bd5a2-127">Layer</span></span> | <span data-ttu-id="bd5a2-128">コンポーネント</span><span class="sxs-lookup"><span data-stu-id="bd5a2-128">Component</span></span> | <span data-ttu-id="bd5a2-129">説明</span><span class="sxs-lookup"><span data-stu-id="bd5a2-129">Description</span></span> |
|----------|-----------|-------------|
| <span data-ttu-id="bd5a2-130">店舗内のハードウェア</span><span class="sxs-lookup"><span data-stu-id="bd5a2-130">In-store hardware</span></span> | [<span data-ttu-id="bd5a2-131">Custom Vision AI Dev Kit</span><span class="sxs-lookup"><span data-stu-id="bd5a2-131">Custom Vision AI Dev Kit</span></span>](https://azure.github.io/Vision-AI-DevKit-Pages/) | <span data-ttu-id="bd5a2-132">分析用に人の画像のみをキャプチャするローカル ML モデルを使用して、ストア内でフィルター処理を行います。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-132">Provides in-store filtering using a local ML model that only captures images of people for analysis.</span></span> <span data-ttu-id="bd5a2-133">IoT Hub によって安全にプロビジョニングと更新が行われます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-133">Securely provisioned and updated through IoT Hub.</span></span><br><br>|
| <span data-ttu-id="bd5a2-134">Azure</span><span class="sxs-lookup"><span data-stu-id="bd5a2-134">Azure</span></span> | [<span data-ttu-id="bd5a2-135">Azure Event Hubs</span><span class="sxs-lookup"><span data-stu-id="bd5a2-135">Azure Event Hubs</span></span>](/azure/event-hubs/) | <span data-ttu-id="bd5a2-136">Azure Event Hubs は、Azure Stream Analytics と密接に統合された、匿名データを取り込むためのスケーラブルなプラットフォームを提供します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-136">Azure Event Hubs provides a scalable platform for ingesting anonymized data that integrates neatly with Azure Stream Analytics.</span></span> |
|  | [<span data-ttu-id="bd5a2-137">Azure Stream Analytics</span><span class="sxs-lookup"><span data-stu-id="bd5a2-137">Azure Stream Analytics</span></span>](/azure/stream-analytics/) | <span data-ttu-id="bd5a2-138">Azure Stream Analytics ジョブは、匿名データを集計し、これを視覚化できるように 15 秒間隔でグループ化します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-138">An Azure Stream Analytics job aggregates the anonymized data and groups it into 15-second windows for visualization.</span></span> |
|  | [<span data-ttu-id="bd5a2-139">Microsoft Power BI</span><span class="sxs-lookup"><span data-stu-id="bd5a2-139">Microsoft Power BI</span></span>](https://powerbi.microsoft.com/) | <span data-ttu-id="bd5a2-140">Power BI には、Azure Stream Analytics からの出力を表示するための、使いやすいダッシュボード インターフェイスが用意されています。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-140">Power BI provides an easy-to-use dashboard interface for viewing the output from Azure Stream Analytics.</span></span> |
| <span data-ttu-id="bd5a2-141">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="bd5a2-141">Azure Stack Hub</span></span> | [<span data-ttu-id="bd5a2-142">App Service</span><span class="sxs-lookup"><span data-stu-id="bd5a2-142">App Service</span></span>](/azure-stack/operator/azure-stack-app-service-overview) | <span data-ttu-id="bd5a2-143">App Service リソースプロバイダー (RP) は、Web アプリ/API および関数のホスティングや管理の機能を含む、エッジ コンポーネントの基本を提供します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-143">The App Service resource provider (RP) provides a base for edge components, including hosting and management features for web apps/APIs and Functions.</span></span> |
| | <span data-ttu-id="bd5a2-144">[Azure Kubernetes Service (AKS) エンジン](https://github.com/Azure/aks-engine) クラスター</span><span class="sxs-lookup"><span data-stu-id="bd5a2-144">Azure Kubernetes Service [(AKS) Engine](https://github.com/Azure/aks-engine) cluster</span></span> | <span data-ttu-id="bd5a2-145">AKS RP では AKS エンジンが Azure Stack Hub にデプロイされているため、Face API コンテナーを実行するためのスケーラブルで回復力のあるエンジンが提供されます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-145">The AKS RP with AKS-Engine cluster deployed into Azure Stack Hub provides a scalable, resilient engine to run the Face API container.</span></span> |
| | <span data-ttu-id="bd5a2-146">Azure Cognitive Services の [Face API コンテナー](/azure/cognitive-services/face/face-how-to-install-containers)</span><span class="sxs-lookup"><span data-stu-id="bd5a2-146">Azure Cognitive Services [Face API containers](/azure/cognitive-services/face/face-how-to-install-containers)</span></span>| <span data-ttu-id="bd5a2-147">Face API コンテナーを備えた Azure Cognitive Services RP により、Contoso のプライベート ネットワーク上で人口統計、感情、および買い物客の一意検出が実現します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-147">The Azure Cognitive Services RP with Face API containers provides demographic, emotion, and unique visitor detection on Contoso's private network.</span></span> |
| | <span data-ttu-id="bd5a2-148">Blob Storage</span><span class="sxs-lookup"><span data-stu-id="bd5a2-148">Blob Storage</span></span> | <span data-ttu-id="bd5a2-149">AI Dev Kit からキャプチャされた画像は、Azure Stack Hub の BLOB ストレージにアップロードされます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-149">Images captured from the AI Dev Kit are uploaded to Azure Stack Hub's blob storage.</span></span> |
| | <span data-ttu-id="bd5a2-150">Azure Functions</span><span class="sxs-lookup"><span data-stu-id="bd5a2-150">Azure Functions</span></span> | <span data-ttu-id="bd5a2-151">Azure Stack Hub で実行されている Azure Functions は、BLOB ストレージからの入力を受け取り、Face API とのやり取りを管理します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-151">An Azure Function running on Azure Stack Hub receives input from blob storage and manages the interactions with the Face API.</span></span> <span data-ttu-id="bd5a2-152">次に、匿名データを、Azure にある Event Hubs クラスターに出力します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-152">It emits anonymized data to an Event Hubs cluster located in Azure.</span></span><br><br>|

## <a name="issues-and-considerations"></a><span data-ttu-id="bd5a2-153">問題と注意事項</span><span class="sxs-lookup"><span data-stu-id="bd5a2-153">Issues and considerations</span></span>

<span data-ttu-id="bd5a2-154">このソリューションの実装方法を決めるときには、以下の点を考慮してください。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-154">Consider the following points when deciding how to implement this solution:</span></span>

### <a name="scalability"></a><span data-ttu-id="bd5a2-155">スケーラビリティ</span><span class="sxs-lookup"><span data-stu-id="bd5a2-155">Scalability</span></span>

<span data-ttu-id="bd5a2-156">このソリューションを複数のカメラと場所にわたってスケーリングできるようにするには、増えた負荷をすべてのコンポーネントで処理できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-156">To enable this solution to scale across multiple cameras and locations, you'll need to make sure that all of the components can handle the increased load.</span></span> <span data-ttu-id="bd5a2-157">次のような措置を取る必要が生じる場合があります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-157">You may need to take actions like:</span></span>

- <span data-ttu-id="bd5a2-158">Stream Analytics のストリーミング ユニット数を増やす。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-158">Increase the number of Stream Analytics streaming units.</span></span>
- <span data-ttu-id="bd5a2-159">Face API デプロイをスケールアウトする。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-159">Scale out the Face API deployment.</span></span>
- <span data-ttu-id="bd5a2-160">Event Hubs クラスターのスループットを増やす。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-160">Increase the Event Hubs cluster throughput.</span></span>
- <span data-ttu-id="bd5a2-161">極端なケースでは、Azure Functions から仮想マシンへの移行が必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-161">For extreme cases, migrate from Azure Functions to a virtual machine may be necessary.</span></span>

### <a name="availability"></a><span data-ttu-id="bd5a2-162">可用性</span><span class="sxs-lookup"><span data-stu-id="bd5a2-162">Availability</span></span>

<span data-ttu-id="bd5a2-163">このソリューションは階層化されているため、ネットワークや電源の障害に対処する方法を検討しておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-163">Since this solution is tiered, it's important to think about how to deal with networking or power failures.</span></span> <span data-ttu-id="bd5a2-164">ビジネス ニーズに応じて、画像をローカルにキャッシュし、接続が回復したときに Azure Stack Hub に転送するメカニズムを実装したい場合があります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-164">Depending on business needs, you might want to implement a mechanism to cache images locally, then forward to Azure Stack Hub when connectivity returns.</span></span> <span data-ttu-id="bd5a2-165">場所に余裕がある場合は、Face API コンテナーを備えた Data Box Edge をその場所に配置する方が適切である可能性もあります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-165">If the location is large enough, deploying a Data Box Edge with the Face API container to that location might be a better option.</span></span>

### <a name="manageability"></a><span data-ttu-id="bd5a2-166">管理の容易性</span><span class="sxs-lookup"><span data-stu-id="bd5a2-166">Manageability</span></span>

<span data-ttu-id="bd5a2-167">このソリューションは多数のデバイスと場所にまたがることがあるため、扱いにくくなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-167">This solution can span many devices and locations, which could get unwieldy.</span></span> <span data-ttu-id="bd5a2-168">[Azure の IoT サービス](/azure/iot-fundamentals/)を使用することで、新しい場所とデバイスを自動的にオンラインにし、最新の状態に保つことができます。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-168">[Azure's IoT services](/azure/iot-fundamentals/) can be used to automatically bring new locations and devices online and keep them up to date.</span></span>

### <a name="security"></a><span data-ttu-id="bd5a2-169">セキュリティ</span><span class="sxs-lookup"><span data-stu-id="bd5a2-169">Security</span></span>

<span data-ttu-id="bd5a2-170">このソリューションでは顧客の画像をキャプチャするため、セキュリティが最も重要な考慮事項となります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-170">This solution captures customer images, making security a paramount consideration.</span></span> <span data-ttu-id="bd5a2-171">すべてのストレージ アカウントが適切なアクセス ポリシーで保護されていることを確認し、またキーを定期的にローテーションします。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-171">Make sure all storage accounts are secured with the proper access policies and rotate keys regularly.</span></span> <span data-ttu-id="bd5a2-172">ストレージ アカウントと Event Hubs に、企業および政府のプライバシー規制に準拠したアイテム保持ポリシーが備わっていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-172">Ensure storage accounts and Event Hubs have retention policies that meet corporate and government privacy regulations.</span></span> <span data-ttu-id="bd5a2-173">また、ユーザー アクセス レベルは必ず階層化してください。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-173">Also make sure to tier the user access levels.</span></span> <span data-ttu-id="bd5a2-174">階層化により、ユーザーは各自のロールに必要なデータにだけアクセスできるようになります。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-174">Tiering ensures that users only have access to the data they need for their role.</span></span>

## <a name="next-steps"></a><span data-ttu-id="bd5a2-175">次のステップ</span><span class="sxs-lookup"><span data-stu-id="bd5a2-175">Next steps</span></span>

<span data-ttu-id="bd5a2-176">この記事で紹介したトピックの関連情報:</span><span class="sxs-lookup"><span data-stu-id="bd5a2-176">To learn more about the topics introduced in this article:</span></span>

- <span data-ttu-id="bd5a2-177">足取り検出パターンによって利用される、[階層化データ パターン](https://aka.ms/tiereddatadeploy)に関するページをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-177">See the [Tiered Data pattern](https://aka.ms/tiereddatadeploy), which is leveraged by the footfall detection pattern.</span></span>
- <span data-ttu-id="bd5a2-178">Custom Vision の使用に関する詳細については、[Custom Vision AI Dev Kit](https://azure.github.io/Vision-AI-DevKit-Pages/) に関するページをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-178">See the [Custom Vision AI Dev Kit](https://azure.github.io/Vision-AI-DevKit-Pages/) to learn more about using custom vision.</span></span> 

<span data-ttu-id="bd5a2-179">ソリューションの例をテストする準備ができたら、[足取り検出のデプロイ ガイド](solution-deployment-guide-retail-footfall-detection.md)に進んでください。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-179">When you're ready to test the solution example, continue with the [Footfall detection deployment guide](solution-deployment-guide-retail-footfall-detection.md).</span></span> <span data-ttu-id="bd5a2-180">デプロイ ガイドでは、コンポーネントをデプロイしてテストするための詳細な手順について説明します。</span><span class="sxs-lookup"><span data-stu-id="bd5a2-180">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>
